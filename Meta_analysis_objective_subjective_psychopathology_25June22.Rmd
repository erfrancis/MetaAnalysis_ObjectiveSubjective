---
title: 'Objective and subjective experiences of childhood adversity: a meta-analysis of their agreement and relationship with psychopathology'
author: "Emma Francis"
output: github_document
always_allow_html: true
---

```{r, echo=FALSE}
knitr::opts_chunk$set(error = TRUE)
```

```{r, results='hide', echo=FALSE, message=FALSE, warning = FALSE}
```

### Overview

##### 1. Meta analysis of agreement between objective and subjective experiences of childhood adversity

**Note: Corresponding data: "Data-extraction_agreement_june2022"**

-   1.1 Derive correlations

-   1.2 Convert correlations to Fishers-z

-   1.3 Prepare to run meta-analysis of agreement

-   1.4 Descriptive statistics

-   1.5 Run meta-analysis of agreement

    -   1.5.1 Maltreatment - Fishers-Z
    -   1.5.2 Maltreatment - Kappa
    -   1.5.3 Bullying
    -   1.5.4 Neighbourhood

-   1.6 Forest plots for meta-analysis

    -   1.6.1 Maltreatment - Fishers-Z
    -   1.6.2 Bullying
    -   1.6.3 Neighbourhood

-   1.7 Publication bias

    -   1.7.1 Maltreatment - Fishers-Z
    -   1.7.2 Maltreatment - Kappa
    -   1.7.3 Bullying

-   1.8 Leave one out analysis

    -   1.8.1 Maltreatment - Kappa
    -   1.8.2 Maltreatment - Correlations
    -   1.8.3 Bullying

##### 2. Meta analysis of objective and subjective experiences of childhood adversity and their association with psychopathology

**Note: Corresponding data: "Data-extraction_june22"**

-   2.1 Examine data

-   2.2 Derive new variables

-   2.3 Convert effect sizes

    -   2.3.1 Prepare data
    -   2.3.2 Convert Cohen's d to r
    -   2.3.3 Convert odds ratio to r
    -   2.3.4 Convert unstandardised betas to r
    -   2.3.5 Convert risk ratios to r
    -   2.3.6 Convert r to Fisher's Z

-   2.4 Descriptive statistics

-   2.5 Do objective and subjective measures of childhood adversity
    independently predict psychopathology?

    -   2.5.1 Maltreatment
    -   2.5.2 Bullying
    -   2.5.3 Neighbourhood
    -   2.5.4 Comparing Estimates of Independent Meta-Analyses or
        Subgroups
    -   2.5.5 Wald-type test for confirmation

-   2.6 Forest plots for meta-analysis

    -   2.6.1 Subjective Maltreatment
    -   2.6.2 Objective Maltreatment
    -   2.6.3 Subjective Bullying
    -   2.6.4 Objective Bullying
    -   2.6.5 Subjective Neighbourhood
    -   2.6.6 Objective Neighbourhood
    -   2.6.7 Combined Subjective and Objective Maltreatment
    -   2.6.8 Combined Subjective and Objective Bullying
    -   2.6.9 Combined Subjective and Objective Neighbourhood

-   2.7 What moderates the independent associations between objective
    and subjective measure of childhood adversity and psychopathology?

    -   2.7.1 Combining moderation analyses for maltreatment & bullying
    -   2.7.2 Test for moderation by mental health outcome
    -   2.7.3 Test for moderation by informant of mental health outcome
    -   2.7.4 Test for moderation by study type
    -   2.7.5 Test for moderation by study quality
    -   2.7.6 Test for moderation by sex
    
-   2.8 Publication bias

    -   2.8.1 Maltreatment
    -   2.8.2 Bullying

-   2.9 Leave one out analysis

    -   2.9.1 Maltreatment
    -   2.9.2 Bullying

#### 1. Meta analysis of agreement between objective and subjective experiences of childhood adversity

##### 1.1 1.1 Read in data, load packages and derive correlations

```{r}
library(readxl)
library(psych) 
library(polycor) 
library(metafor) 
library(dplyr)

data <- data.frame(read_excel("/Users/emma/Desktop/Data-extraction_agreement_june2022.xlsx")) # Read dataset
str(data)
View(data)

# Derive variable for the correlation between objective and subjective measures
data$r_obj_subj <- NA

# Input the correlation for studies already reporting the correlation between obj & subj measures
data$r_obj_subj[data$es_type=="correlation"] <- data$es_agree[data$es_type=="correlation"] 
describe(data$r_obj_subj)  

# Derive variable for the variance of the correlation between objective and subjective measures
data$r_obj_subj_var <- NA

# Input the variance for studies already reporting the SE of the correlation between obj & subj measures
# Note: Vr = (1 - r^2)^2 / n - 1 (Borenstein et al., 2009)
data$r_obj_subj_var[data$es_type=="correlation"] <- (1 - data$r_obj_subj[data$es_type=="correlation"]^2)^2 / (data$n_total[data$es_type=="correlation"] - 1)
describe(data$r_obj_subj_var)

#### Derive correlation for studies reporting kappas 
# To do so, need to define function to derive tetrachoric correlations from n_obj_subj, n_obj_only, n_subj_only, n_none
# This function makes a 2x2 table with Ns of groups with:
# - subjective and objective measures (n_obj_subj)
# - objective measures only (n_obj_only)
# - subjective measures only (n_subj_only)
# - neither subjective nor objective measures (n_none)
# Then the polychoric correlation and variance is calculated from the 2x2 table
# the function returns the correlation between objective & subjective measures and variance

# Check Ns in each group are reported for studies reporting kappas
describe(data$n_obj_subj[data$es_type=="kappa"]) # n with concordant objective and subjective measures
describe(data$n_obj_only[data$es_type=="kappa"]) # n with objective measures only
describe(data$n_subj_only[data$es_type=="kappa"]) # n with subjective measures only
describe(data$n_none[data$es_type=="kappa"]) # n with neither objective nor subjective measures

# Define function to derive tetrachoric correlations
tetrachoric_cor <- function(n_obj_subj, n_obj_only, n_subj_only, n_none) {
  table <- matrix(nrow=2, ncol=2, 
                  c(n_obj_subj, n_obj_only, n_subj_only, n_none)) # input Ns in each group into a 2x2 table
  results <- polychor(table, std.err=TRUE) # calculate the tetrachoric correlation
  r <- results$rho
  var <- results$var
  return(c(r, var)) # return the correlation and variance
}

# Derive tetrachoric correlations for studies reporting kappas
corr_tetra <- as.data.frame(mapply(tetrachoric_cor, 
                                   data$n_obj_subj[data$es_type=="kappa"], # n with concordant objective and subjective measures
                                   data$n_obj_only[data$es_type=="kappa"], # n with objective measures only
                                   data$n_subj_only[data$es_type=="kappa"], # n with subjective measures only
                                   data$n_none[data$es_type=="kappa"])) # n with neither objective nor subjective measures
corr_tetra
# The columns show the results for each study, row 1 shows the correlation and row 2 shows the variance

table(data$es_type)

# Input the correlation between objective and subjective measures into the variable
data$r_obj_subj[data$es_type=="kappa"] <- as.vector(unlist(corr_tetra[1,])) # 1 = first row
describe(data$r_obj_subj) 

# Input the variance of the correlation between objective and subjective measures into the variable
data$r_obj_subj_var[data$es_type=="kappa"] <- as.vector(unlist(corr_tetra[2,])) # 2 = second row
describe(data$r_obj_subj_var) 
```

##### 1.2 Convert correlations to Fishers-z

```{r}
# Create new variables for Fishers-Z conversion
data$z_obj_subj <- NA

# Convert correlations to Fishers-Z
data$z_obj_subj <- fisherz(data$r_obj_subj)
# Compare variables for subjective effect sizes
list(data$z_obj_subj)
list(data$r_obj_subj)

# Check number of effect sizes are the same between r and Fishers-Z 
describe(data$z_obj_subj) 
describe(data$r_obj_subj) 

mean(data$z_obj_subj[!is.na(data$z_obj_subj)]) 
describe(data$z_obj_subj) 

# Derive variables for variance of Fisher's Z
# Variance = 1/n-3 (see https://www.meta-analysis.com/downloads/Meta-analysis%20Effect%20sizes%20based%20on%20correlations.pdf)
data$z_obj_subj_var <- NA
data$z_obj_subj_var <- 1 / (data$n_total-3)
as.data.frame(describe(data$z_obj_subj_var))

# Show the variance converted to Fisher's z
list(data$z_obj_subj_var)
```

##### 1.3 Prepare to run meta-analysis of agreement

```{r}
# Derive variable indexing whether the study assesses maltreatment, bullying or neighbourhood adversity
table(data$Subj_Exposure)
data$exposure_type_broad <- "maltreatment" # code to maltreatment unless otherwise specified

# Code all measures including the terms "peer_vic", "relational_vic", or "overt_vic" to bullying
data$exposure_type_broad[grepl("peer_vic", data$Subj_Exposure, ignore.case = TRUE)] <- "bullying"
data$exposure_type_broad[grepl("relational_vic", data$Subj_Exposure, ignore.case = TRUE)] <- "bullying"
data$exposure_type_broad[grepl("overt_vic", data$Subj_Exposure, ignore.case = TRUE)] <- "bullying"

# Code all measures including the terms "neighbourhood", "neighborhood" to neighbourhood
data$exposure_type_broad[grepl("neighborhood_disorder", data$Subj_Exposure, ignore.case = TRUE)] <- "neighbourhood"
data$exposure_type_broad[grepl("neighbourhood_violence", data$Subj_Exposure, ignore.case = TRUE)] <- "neighbourhood"
table(data$exposure_type_broad)

# Compare original coding to new broad categories of adversity type
data %>%  dplyr::select(author, Subj_Exposure, exposure_type_broad)

# Derive effect size ID variable
data$es_id <- 1:nrow(data)
```

##### 1.4 Descriptive statistics

```{r}
# Descriptive data for included agreement studies
# Number of independent studies 
k_studies <- data %>%
  group_by(author) %>%
  dplyr::summarise(m = max(author)) %>% nrow()
k_studies

# Number of cohorts
k_cohort <- data %>%
  group_by(cohort_distinct) %>%
  dplyr::summarise(m = max(cohort)) %>% nrow()
k_cohort

# Total sample size
data %>%
  group_by(cohort) %>%
  dplyr::summarise(m = max(n_total))%>%
  dplyr::summarise(sum = sum(m))

# Age of self-report
age_self <- data %>%
  group_by(cohort_distinct) %>%
  dplyr::summarise(mean_age_self = mean(age_self)) %>% #to edit 
  dplyr::summarise(overall=mean(mean_age_self, na.rm=TRUE))
age_self

# Number and type of effect sizes 
#**Note: es_type is the original effect sizes reported (before deriving correlations from studies reporting kappas)**
describe(data$r_obj_subj)$n
table(data$es_type) 

# es reported for each exposure
#es for maltreatment
n_es_mal <- length(data$es_type[!is.na(data$es_type) & data$exposure_type_broad=="maltreatment"])
n_es_mal

# es for bullying
n_es_mal <- length(data$es_type[!is.na(data$es_type) & data$exposure_type_broad=="bullying"])
n_es_mal

# es for neighbourhood
n_es_neigh <- length(data$es_type[!is.na(data$es_type) & data$exposure_type_broad=="neighbourhood"])
n_es_neigh

# Average proportion female
perc_female <- data %>%
  group_by(cohort_distinct) %>%
  dplyr::summarise(mean_percent_female = mean(percent_female)) %>%
  dplyr::summarise(overall=mean(mean_percent_female, na.rm=TRUE))
perc_female

# Number of studies reporting maltreatment
data %>%
  group_by(author) %>%
  filter(exposure_type_broad=="maltreatment")%>%
  dplyr::summarise(m = max(author)) %>% nrow()

# Number of studies reporting bullying
data %>%
  group_by(author) %>%
  filter(exposure_type_broad=="bullying")%>%
  dplyr::summarise(m = max(author)) %>% nrow()

# Number of studies reporting neighbourhood
data %>%
  group_by(author) %>%
  filter(exposure_type_broad=="neighbourhood")%>%
  dplyr::summarise(m = max(author)) %>% nrow()
```

##### 1.5 Run meta-analysis of agreement

###### 1.5.1 Maltreatment - Fishers-Z

```{r}
# Maltreatment - Fishers Z
maltreat_z <- rma.mv(z_obj_subj, z_obj_subj_var, data=data, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort), subset = exposure_type_broad == "maltreatment")
maltreat_z

# Convert estimate and CIs back to r 
round(fisherz2r(c(maltreat_z$beta, maltreat_z$ci.lb, maltreat_z$ci.ub)),2)
```

###### 1.5.2 Maltreatment - Kappa

```{r}
# Meta-analysis of Cohens kappa
data$kappa_var <- data$se_agree^2 # derive variance of the kappa
maltreat_kappa <- rma.mv(es_agree, kappa_var, data=data, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
       subset = exposure_type_broad == "maltreatment" & es_type=="kappa")
maltreat_kappa 

# Convert estimate and CIs back to r 
round(c(maltreat_kappa$b, maltreat_kappa$ci.lb, maltreat_kappa$ci.ub),2)
```

###### 1.5.3 Bullying

```{r}
# Bullying - Fishers Z
bully_z <- rma.mv(z_obj_subj, z_obj_subj_var, data=data, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                     subset = exposure_type_broad == "bullying")
bully_z 

# Convert estimate and CIs back to r
round(fisherz2r(c(bully_z$beta, bully_z$ci.lb, bully_z$ci.ub)),2) 
```

###### 1.5.4 Neighbourhood

```{r}
# Neighbourhood - Fishers Z 
neigh_z <- rma.mv(z_obj_subj, z_obj_subj_var, data=data, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                  subset = exposure_type_broad == "neighbourhood" & es_type=="correlation")
neigh_z 

# Convert estimate and CIs back to r
round(fisherz2r(c(neigh_z$beta, neigh_z$ci.lb, neigh_z$ci.ub)),2)
```

##### 1.6 Forest plots for meta-analysis
**Create a forest plot for each of the subtypes of adversity exposure**

###### 1.6.1 Maltreatment - Fishers-Z

```{r}
maltreatment_data <- subset(data, exposure_type_broad=="maltreatment")
maltreatment_data2 <- maltreatment_data[order(maltreatment_data$author, maltreatment_data$year),] #re-order
maltreatment_data2$refPlot <- paste0(maltreatment_data2$author, " ", maltreatment_data2$year)


# Maltreatment - Re-run meta-analyses - Fishers-Z
maltreat_z <- rma.mv(z_obj_subj, z_obj_subj_var, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                     data = maltreatment_data2, subset = exposure_type_broad == "maltreatment" & !is.na(exposure_type_broad),
                     slab=paste(author, es_id, sep=", "))
maltreat_z 

# Forest plot
library(mgsub)
forest(maltreat_z,
       transf=transf.ztor, # inverse of Fisher's r-to-z transformation
       order = order(maltreatment_data2$author, maltreatment_data2$year), 
       xlim=c(-1.5, 1.5), at=c(-0.2,0,0.2,0.4,0.6,0.8,1), 
       xlab = "Correlation", 
       mlab="Multi-level Meta-Analysis Model", 
       slab=NA,
       ilab=cbind(paste0(maltreatment_data2$refPlot), 
                  mgsub(maltreatment_data2$Obj_Exposure, c("_", "(3 to 8 yrs)", "(9 to 16 yrs)"), c(" ", "(3-8 years)", "(9-16 years)"))),
       ilab.xpos=c(-1.55, -1.1), cex=0.45, 
       ilab.pos = c(4, 4),
       top=1.5) 
par(font=2)
text(c(-1.4, -0.88, 1.3), 43, c("Reference", "Maltreatment type", "Correlation [95% CI]"), cex=0.45)
#save 575x600 
```

###### 1.6.2 Bullying

```{r}
bullying_data <- subset(data, exposure_type_broad=="bullying")
bullying_data2 <- bullying_data[order(bullying_data$author, bullying_data$year),]
#re-order
bullying_data2$refPlot <- paste0(bullying_data2$author, " ", bullying_data2$year)

# Removes underscores from Obj_Exposure variable
bullying_data2$Obj_Exposure <- gsub("_"," ", bullying_data$Obj_Exposure)
bullying_data2$Obj_Exposure

# Bullying - Re-run meta-analyses - Fishers-Z
bully_z <- rma.mv(z_obj_subj, z_obj_subj_var, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                  data=bullying_data2, subset = exposure_type_broad == "bullying" & !is.na(exposure_type_broad),
                  slab=paste(author, es_id, sep=", "))
bully_z

# Forest plot
forest(bully_z,
       transf=transf.ztor, 
       order = order(bullying_data2$author, bullying_data2$year), 
       xlim=c(-1.7, 1.5), at=c(-0.2,0,0.2,0.4,0.6, 0.8), 
       xlab = "Correlation", 
       mlab="Multivariate Meta-Analysis Model",
       slab=NA, 
       ilab=cbind(bullying_data2$refPlot, bullying_data2$Obj_Exposure),  
      ilab.xpos=c(-1.7,-0.9), cex=0.4, 
       ilab.pos = c(4, 4, 4),
       top=3) 
par(font=2)
text(c(-1.5, -0.7, 1.25), 21.5, c("Reference", "Bullying type", "Correlation [95% CI]"), cex=0.4)
```

###### 1.6.3 Neighbourhood

```{r}
neighbour_data <- subset(data, exposure_type_broad=="neighbourhood")

# Removes underscores from Subj_Exposure variable
neighbour_data$Subj_Exposure <- gsub("_"," ", neighbour_data$Subj_Exposure)

neighbour_data$Subj_Exposure

# Neighbourhood - Re-run meta-analyses - Fishers-Z
neigh_z <- rma.mv(z_obj_subj, z_obj_subj_var, data=neighbour_data, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                  subset=es_type=="correlation")
neigh_z 

# Convert estimate and CIs back to r
fisherz2r(c(neigh_z$beta, neigh_z$ci.lb, neigh_z$ci.ub))    

# Forest plot
forest(neigh_z,
       transf=transf.ztor, 
       order = order(neighbour_data$author, neighbour_data$year), 
       xlim=c(-1.7, 1.5), at=c(-0.2,0,0.2,0.4,0.6, 0.8), 
       xlab = "Correlation", 
       mlab="Multilevel Meta-Analysis Model",
       slab=NA, 
       ilab=cbind(paste0(neighbour_data$author[neighbour_data$es_type=="correlation"], " ",
                  neighbour_data$year[neighbour_data$es_type=="correlation"]), 
                  neighbour_data$Subj_Exposure[neighbour_data$es_type=="correlation"]), 
       ilab.xpos= c(-1.65, -0.9), cex=0.6, 
       ilab.pos = c(4, 4),
       top=2) 
par(font=2)
text(c(-1.47,-0.63, 1.3), 3.2, c("Reference", "Neighbourhood adversity type", "Correlation [95% CI]"), cex=0.6)
# save 740x360
```

##### 1.7 Test publication bias

    # Information on adapting Eggers test in multi-level meta-analysis models: https://stats.stackexchange.com/questions/134768/metafor-package-in-r-ranktest-for-multivariate-meta-analysis
    # Note: SE and variance should not be used because they are directly related to the correlation coefficient, see: https://stat.ethz.ch/pipermail/r-sig-meta-analysis/2020-May/002086.html
    # "There is an inherent correlation between correlations and their sampling variances, which can lead to false positives."
    # Wolfgang Viechtbauer recommends using the inverse sample sizes as the predictor

###### 1.7.1 Maltreatment - Fishers-Z

```{r}
egger_maltreat_z <- rma.mv(z_obj_subj, z_obj_subj_var, data=data, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                           mod = I(1/n_total),  # moderator = the inverse sample size
                           subset = exposure_type_broad == "maltreatment") 
egger_maltreat_z
```

###### 1.7.2 Maltreatment - Kappa

```{r}
egger_maltreat_kappa <- rma.mv(es_agree, kappa_var, data=data, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                               subset = exposure_type_broad == "maltreatment" & es_type=="kappa",
                               mod = kappa_var) 
egger_maltreat_kappa
```

###### 1.7.3 Bullying

```{r}
egger_bully_z <- rma.mv(z_obj_subj, z_obj_subj_var, data=data, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                        mods =  I(1/n_total),
                        subset = exposure_type_broad == "bullying")
egger_bully_z

# Make funnel plot to observe the relationship between sample size and agreement between subjective and objective measures
funnel(x=data$r_obj_subj[data$exposure_type_broad == "bullying"], yaxis="ni", ni=data$n_total[data$exposure_type_broad == "bullying"], xlab="Correlation") #label your x-axis according to the effect size)
```

##### 1.8 Leave one out analysis

###### 1.8.1 Maltreatment - Kappa

```{r}
groupids <- unique(data$author[data$exposure_type_broad=="maltreatment"])
groupids <- na.omit(groupids)

leave1out_study <- matrix(rep(NA, length(groupids)), ncol=6, nrow=length(groupids))  

for(i in 1:length(groupids)) {  
  dataexcl <- subset(data, exposure_type_broad=="maltreatment") # subset to maltreatment data
  dataexcl <- subset(dataexcl, author!=groupids[i])  # remove each reference
  print(nrow(dataexcl))
  
  N_rows <- psych::describe(dataexcl$n_total)$n
  mean_N <- psych::describe(dataexcl$n_total)$mean

  # Run meta-analysis for maltreatment obj and subj measures 
  maltreat_kappa <- rma.mv(es_agree, kappa_var, data=dataexcl, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                           subset = exposure_type_broad == "maltreatment" & es_type=="kappa")
  
  # Extract results
  leave1out_study[i,1] <- i # number study omitted
  leave1out_study[i,2] <- N_rows 
  leave1out_study[i,3] <- mean_N 
  leave1out_study[i,4] <- maltreat_kappa$beta[1] #  ES
  leave1out_study[i,5] <- maltreat_kappa$ci.lb[1] # low CI
  leave1out_study[i,6] <- maltreat_kappa$ci.ub[1] # upper CI

  
}

leave1out_study
leave1out_study[,1] <- as.vector(groupids) # Name studies
leave1out_study_df <- as.data.frame(leave1out_study) # Convert to dataframe
names(leave1out_study_df) <-c('author', 'N_rows', 'Mean_N', 
                              'es', 'ci.lb', 'ci.ub') # Rename columns
# Convert columns from character to numeric
leave1out_study_df <- leave1out_study_df %>% mutate_at(c('N_rows', 'Mean_N', 
                                                         'es', 'ci.lb', 'ci.ub'), as.numeric)

# Check studies that when removed, led to the minimum and maximum effect size
# maltreatment obj and subj agreement meta-analysis
leave1out_study_df[which.min(leave1out_study_df$es),c('author','es', 'ci.lb', 'ci.ub')]
leave1out_study_df[which.max(leave1out_study_df$es),c('author','es', 'ci.lb', 'ci.ub')]
```

###### 1.8.2 Maltreatment - Correlations

```{r}
groupids <- unique(data$author[data$exposure_type_broad=="maltreatment"])
groupids <- na.omit(groupids)

leave1out_study <- matrix(rep(NA, length(groupids)), ncol=6, nrow=length(groupids))  

for(i in 1:length(groupids)) {  
  dataexcl <- subset(data, exposure_type_broad=="maltreatment") # subset to maltreatment data
  dataexcl <- subset(dataexcl, author!=groupids[i])  
  print(nrow(dataexcl))
  
  N_rows <- psych::describe(dataexcl$n_total)$n
  mean_N <- psych::describe(dataexcl$n_total)$mean
  # Run meta-analysis for maltreatment obj and subj measures
  maltreat_z <- rma.mv(z_obj_subj, z_obj_subj_var, data=dataexcl, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                       subset = exposure_type_broad == "maltreatment")
  
  # Extract results
  leave1out_study[i,1] <- i # number study omitted
  leave1out_study[i,2] <- N_rows 
  leave1out_study[i,3] <- mean_N 
  leave1out_study[i,4] <- fisherz2r(maltreat_z$beta[1]) #  ES
  leave1out_study[i,5] <- fisherz2r(maltreat_z$ci.lb[1]) # low CI
  leave1out_study[i,6] <- fisherz2r(maltreat_z$ci.ub[1]) # upper CI
  
}

leave1out_study
leave1out_study[,1] <- as.vector(groupids) # Name studies
leave1out_study_df <- as.data.frame(leave1out_study) # Convert to dataframe
names(leave1out_study_df) <-c('author', 'N_rows', 'Mean_N', 
                              'es', 'ci.lb', 'ci.ub') # Rename columns
# Convert columns from character to numeric
leave1out_study_df <- leave1out_study_df %>% mutate_at(c('N_rows', 'Mean_N', 
                                                         'es', 'ci.lb', 'ci.ub'), as.numeric)

# Check studies that when removed, led to the minimum and maximum effect size
# maltreatment obj and subj agreement meta-analysis
leave1out_study_df[which.min(leave1out_study_df$es),c('author','es', 'ci.lb', 'ci.ub')]
leave1out_study_df[which.max(leave1out_study_df$es),c('author','es', 'ci.lb', 'ci.ub')]
```

###### 1.8.3 Bullying

```{r}
groupids <- unique(data$author[data$exposure_type_broad=="bullying"])
groupids <- na.omit(groupids)

leave1out_study <- matrix(rep(NA, length(groupids)), ncol=6, nrow=length(groupids))  

for(i in 1:length(groupids)) {  
  dataexcl <- subset(data, exposure_type_broad=="bullying") # subset to bullying data
  dataexcl <- subset(dataexcl, author!=groupids[i])  
  print(nrow(dataexcl))
  
  N_rows <- psych::describe(dataexcl$n_total)$n
  mean_N <- psych::describe(dataexcl$n_total)$mean
  # Run meta-analysis for bullying obj and subj measures
  maltreat_z <- rma.mv(z_obj_subj, z_obj_subj_var, data=dataexcl, random=list(~ 1 | es_id, ~ 1 | author, ~1 | cohort),
                       subset = exposure_type_broad == "bullying")
  
  # Extract results
  leave1out_study[i,1] <- i # number study omitted
  leave1out_study[i,2] <- N_rows 
  leave1out_study[i,3] <- mean_N 
  leave1out_study[i,4] <- fisherz2r(maltreat_z$beta[1]) #  ES
  leave1out_study[i,5] <- fisherz2r(maltreat_z$ci.lb[1]) # low CI
  leave1out_study[i,6] <- fisherz2r(maltreat_z$ci.ub[1]) # upper CI
  
  
}

leave1out_study
leave1out_study[,1] <- as.vector(groupids) # Name studies
leave1out_study_df <- as.data.frame(leave1out_study) # Convert to dataframe
names(leave1out_study_df) <-c('author', 'N_rows', 'Mean_N', 
                              'es', 'ci.lb', 'ci.ub') # Rename columns
# Convert columns from character to numeric
leave1out_study_df <- leave1out_study_df %>% mutate_at(c('N_rows', 'Mean_N', 
                                                         'es', 'ci.lb', 'ci.ub'), as.numeric)

# Check studies that when removed, led to the minimum and maximum effect size
# bullying obj and subj agreement meta-analysis
leave1out_study_df[which.min(leave1out_study_df$es),c('author','es', 'ci.lb', 'ci.ub')]
leave1out_study_df[which.max(leave1out_study_df$es),c('author','es', 'ci.lb', 'ci.ub')]

```

#### 2. Meta analysis of objective and subjective experiences of childhood adversity and their association with psychopathology

##### 2.1 Examine data

```{r}
# Load packages, define paths, read in data
library("readxl") # read in Excel data
library(dplyr) # for data manipulation
library(metafor) # for meta-analysis
library(mgsub) #for manipulation of string variables
library(psych)

# Define paths for working directories 
Data <- "/Users/emma/Desktop"

# Read in data 
setwd(Data)
data <- data.frame(read_excel("Data-extraction_june22.xlsx"))
head(data)
str(data)
```

##### 2.2 Derive new variables

```{r}
# Derive broad exposure variable for bullying, maltreatment, neighbourhood disadvantage 
table(data$Exposure_Type_Subj)

# Bullying
data$exposure_type_broad <- NA
data$exposure_type_broad[data$Exposure_Type_Subj=="Bullying_Victimization_T1" |
                           data$Exposure_Type_Subj=="Bullying_Victimization_T2"  |
                           data$Exposure_Type_Subj=="Bullying_Victimization" | 
                           data$Exposure_Type_Subj=="Peer_Victimization"] <- "bullying"
# Maltreatment
data$exposure_type_broad[data$Exposure_Type_Subj=="Acceptance_And_Self-Esteem" |
                           data$Exposure_Type_Subj=="Autonomy"|
                           data$Exposure_Type_Subj=="Child_Maltreatment" | 
                           data$Exposure_Type_Subj=="Child_Neglect" |
                           data$Exposure_Type_Subj=="Child_Physical_Abuse"|
                           data$Exposure_Type_Subj=="Child_Sexual_Abuse" | 
                           data$Exposure_Type_Subj=="Emotional" |
                           data$Exposure_Type_Subj=="Emotional_Abuse"|
                           data$Exposure_Type_Subj=="Family_Violence" | 
                           data$Exposure_Type_Subj=="Neglect"|
                           data$Exposure_Type_Subj=="Physical_Abuse" | 
                           data$Exposure_Type_Subj=="Physical_Violence" |
                           data$Exposure_Type_Subj=="Psychological_Abuse"|
                          data$Exposure_Type_Subj=="Psychological_Safety_And_Security"|
                           data$Exposure_Type_Subj=="Restriction" |
                           data$Exposure_Type_Subj=="Sexual"|
                           data$Exposure_Type_Subj=="Sexual_Abuse"] <- "maltreatment"

# Neighbourhood 
data$exposure_type_broad[data$Exposure_Type_Subj=="Neighbourhood_Disorder" |
                           data$Exposure_Type_Subj=="Neighbourhood_Safety"] <- "neighbourhood"
table(data$exposure_type_broad)

#check any outcomes that haven't been coded - should be 0
data %>% dplyr::filter (is.na(exposure_type_broad)) %>%
  dplyr::select(Author, Exposure_Type_Subj)

# Compare original coding to new broad categories of adversity type
data %>%  dplyr::select(Author, Exposure_Type_Subj, exposure_type_broad)

# Derive variable for internalizing mental health outcomes depression, anxiety, eating disorder, self-harm, suicide)
table(data$MH_Outcome)

# Create MHoutcome_broad var
data$MHoutcome_broad <- NA
# Code internalising problems
data$MHoutcome_broad[data$MH_Outcome=="Anxiety_Symptoms" |
                       data$MH_Outcome=="Anxiety_Symptoms_T1"  |
                       data$MH_Outcome=="Anxiety_Symptoms_T2" | 
                       data$MH_Outcome=="Any_Internalising_Disorder_Diagnosis" |
                       data$MH_Outcome=="Depression_Diagnosis"  |
                       data$MH_Outcome=="Depression_Symptoms" | 
                       data$MH_Outcome=="Depression_Symptoms_T1" |
                       data$MH_Outcome=="Depression_Symptoms_T2" | 
                       data$MH_Outcome=="Depressive_Symptoms" |
                       data$MH_Outcome=="Depressive_Symptoms_Grade_10"  |
                       data$MH_Outcome=="Depressive_Symptoms_Grade_5" | 
                       data$MH_Outcome=="Depressive_Symptoms_Grade_6" |
                       data$MH_Outcome=="Depressive_Symptoms_Grade_9" |
                       data$MH_Outcome=="Dysthymia_Diagnosis" |
                       data$MH_Outcome=="Generalized_Anxiety_Disorder_Diagnosis" |
                       data$MH_Outcome=="Internalising_Symptoms" |
                       data$MH_Outcome=="Internalising_Symptoms_CBCL" |
                       data$MH_Outcome=="Internalising_Symptoms_YSR" |
                       data$MH_Outcome=="PTSD_Diagnosis" |
                       data$MH_Outcome=="PTSD_Symptoms" |
                       data$MH_Outcome=="Serious_Psychological_Distress_Symptoms" |
                       data$MH_Outcome=="Social_Anxiety_Symptoms" |
                       data$MH_Outcome=="Social_Anxiety_Symptoms_T1" |
                       data$MH_Outcome=="Social_Anxiety_Symptoms_T2" |
                       data$MH_Outcome=="Suicidal_Thoughts" ] <- "internalising"
# Code externalising problems
data$MHoutcome_broad[data$MH_Outcome=="Alcohol_Abuse_And_Or_Dependence_Diagnosis" |
                       data$MH_Outcome=="Alcohol_Use"  |
                       data$MH_Outcome=="Antisocial_Personality_Disorder_Diagnosis" | 
                       data$MH_Outcome=="Any_Externalising_Disorder_Diagnosis" |
                       data$MH_Outcome=="Drug_Abuse_And_Or_Dependence"  |
                       data$MH_Outcome=="Externalising_Symptoms" | 
                       data$MH_Outcome=="Marijuana_Use" |
                       data$MH_Outcome=="Person_Offences_Externalising_Problems" | 
                       data$MH_Outcome=="Property_Offences_Externalising_Problems" |
                       data$MH_Outcome=="Externalising_Symptoms" |
                      data$MH_Outcome=="Person_Offences_Externalising" |
                      data$MH_Outcome=="Externalising_Symptoms" |
                      data$MH_Outcome=="Externalising_Symptoms_YSR" | 
                       data$MH_Outcome=="Externalising_Symptoms_CBCL" |
                      data$MH_Outcome=="Property_Offences_Externalising"] <- "externalising"
# Code psychotic experiences 
data$MHoutcome_broad[data$MH_Outcome=="Psychotic_Experiences_Symptoms" |
                       data$MH_Outcome=="Non_Clinical_Psychotic_Experiences_Symptoms"] <- "psychotic_experiences"

table(data$MHoutcome_broad, useNA = "always")

# Compare original coding to new broad categories of mental health type
data %>%  dplyr::select(Author, MH_Outcome, MHoutcome_broad)

# Check which outcomes haven't been coded 
data %>% dplyr::filter (is.na(MHoutcome_broad)) %>%
  dplyr::select(Author, MH_Outcome)
```


##### 2.3 Convert effect sizes

###### 2.3.1 Prepare data

```{r}
# Make new variable to input correlation coefficient and variance for objective measure
data$r_objective_es <- NA
data$r_objective_var <- NA

# Look at original effect sizes prior to converting
table(data$Type_of_effect_size_obj)

# Include results for studies that have correlations or standardised betas already
data$r_objective_es[data$Type_of_effect_size_obj=="correlation" |
                      data$Type_of_effect_size_obj=="standardised_beta"] <- 
  data$Effect_size_obj[data$Type_of_effect_size_obj=="correlation" |
                                                        data$Type_of_effect_size_obj=="standardised_beta"]
data$r_objective_var[data$Type_of_effect_size_obj=="correlation" |
                     data$Type_of_effect_size_obj=="standardised_beta"] <- 
  data$SE_obj[data$Type_of_effect_size_obj=="correlation" |
                                               data$Type_of_effect_size_obj=="standardised_beta"]^2

describe(data$r_objective_es)
table(data$Type_of_effect_size_obj[is.na(data$r_objective_es)])

# Repeat for subjective effect sizes

# Make new variable to input correlation coefficient and variance for subjective measure
data$r_subjective_es <- NA
data$r_subjective_var <- NA

# Look at effect sizes prior to converting
table(data$Type_of_effect_size_subj)

# Include results for studies that have correlations or standardised betas already
data$r_subjective_es[data$Type_of_effect_size_subj=="correlation" |
                       data$Type_of_effect_size_subj=="standardised_beta"] <- 
  data$Effect_size_subj[data$Type_of_effect_size_subj=="correlation" |
                          data$Type_of_effect_size_subj=="standardised_beta"]
data$r_subjective_var[data$Type_of_effect_size_subj=="correlation" |
                        data$Type_of_effect_size_subj=="standardised_beta"] <- 
  data$SE_subj[data$Type_of_effect_size_subj=="correlation" |
                 data$Type_of_effect_size_subj=="standardised_beta"]^2

describe(data$r_subjective_es)
table(data$Type_of_effect_size_subj[is.na(data$r_subjective_es)])
```

###### 2.3.2 Convert Cohen's d to r

```{r}
# Function to convert cohen's d to r 
# Conversion equation from: https://www.meta-analysis.com/downloads/Meta-analysis%20Converting%20among%20effect%20sizes.pdf
# Produces the same results as "d_to_r" function from "effectsize" 
cohens_d_to_r <- function(d, se_d) {
  r = d / sqrt(d^2 + 4) # convert cohen's d to r
  return(r)
}

# Function to convert cohen's d SE to variance of r 
# Conversion equation from: https://www.meta-analysis.com/downloads/Meta-analysis%20Converting%20among%20effect%20sizes.pdf
cohens_d_to_r_variance <- function(d, se_d) {
  var_d = se_d^2 # convert se of cohen's d to variance 
  var_r = 4^2 * var_d / (d^2 + 4)^3 # convert cohen's d and variance of d to variance of r
  return(var_r)
}

# Check studies reporting cohen's d
data %>% dplyr::filter (Type_of_effect_size_obj == "cohens_d") %>% 
  group_by(Author) %>%   summarise(n = n())

# Convert effect sizes for the objective measure 
# Convert effect sizes
data$r_objective_es[data$Type_of_effect_size_obj == "cohens_d"] <- 
  cohens_d_to_r(d = data$Effect_size_obj[data$Type_of_effect_size_obj == "cohens_d"],
                se_d = data$SE_obj[data$Type_of_effect_size_obj == "cohens_d"])
# Convert SE to variance
data$r_objective_var[data$Type_of_effect_size_obj == "cohens_d"] <- 
  cohens_d_to_r_variance(d = data$Effect_size_obj[data$Type_of_effect_size_obj == "cohens_d"],
                se_d = data$SE_obj[data$Type_of_effect_size_obj == "cohens_d"])

# Check results before and after converting
# effect sizes
data$Effect_size_obj[data$Type_of_effect_size_obj == "cohens_d"] # before converting
data$r_objective_es[data$Type_of_effect_size_obj == "cohens_d"] # after converting
# variance
data$SE_obj[data$Type_of_effect_size_obj == "cohens_d"]^2 # var before converting
data$r_objective_var[data$Type_of_effect_size_obj == "cohens_d"] # after converting

# Repeat for subjective measure
# Convert effect sizes
data$r_subjective_es[data$Type_of_effect_size_subj == "cohens_d"] <- 
  cohens_d_to_r(d = data$Effect_size_subj[data$Type_of_effect_size_subj == "cohens_d"],
                se_d = data$SE_subj[data$Type_of_effect_size_subj == "cohens_d"])
# Convert SE to variance
data$r_subjective_var[data$Type_of_effect_size_subj == "cohens_d"] <- 
  cohens_d_to_r_variance(d = data$Effect_size_subj[data$Type_of_effect_size_subj == "cohens_d"],
                         se_d = data$SE_subj[data$Type_of_effect_size_subj == "cohens_d"])

# Check results before and after converting
# effect sizes
data$Effect_size_subj[data$Type_of_effect_size_subj == "cohens_d"] # before converting
data$r_subjective_es[data$Type_of_effect_size_subj == "cohens_d"] # after converting
# variance
data$SE_subj[data$Type_of_effect_size_subj == "cohens_d"]^2 # var before converting
data$r_subjective_var[data$Type_of_effect_size_subj == "cohens_d"] # after converting

## Check p-values before and after converting to r
# Derive function to calculate p-value (see box in https://www.bmj.com/content/343/bmj.d2304)
p_function <- function (es, se) {
  z <- es/se
  p <- exp(-0.717*z - 0.416*z^2)
  return(p)
} 
# P-values 
p_function(data$Effect_size_subj[data$Type_of_effect_size_subj=="cohens_d"], 
           data$SE_subj[data$Type_of_effect_size_subj=="cohens_d"]) # before converting to r
p_function(data$r_subjective_es[data$Type_of_effect_size_subj=="cohens_d"], 
           sqrt(data$r_subjective_var[data$Type_of_effect_size_subj=="cohens_d"])) # after converting to r
```

###### 2.3.3 Convert odds ratio to r

```{r}
# Function to convert odds ratio to R
# Conversion equation from: https://www.meta-analysis.com/downloads/Meta-analysis%20Converting%20among%20effect%20sizes.pdf
# gives same results as "lores" function from "compute.es" but does not require Ns for separate groups
OR_to_r <- function(OR, logSE) {
  log_odds = log(OR) # log transform odds ratio 
  d = log_odds * (sqrt(3)/3.14159) # convert log odds to cohen's d
  var_d = logSE^2 * (3 / 3.14159^2) # convert log odds SE to variance of cohen's d
  r = d / sqrt(d^2 + 4) # convert cohen's d to r
  var_r = 4^2 * var_d / (d^2 + 4)^3 # convert cohen's d and variance of d to variance of r
  se_r = sqrt(var_r) 
  return(r)
}

# Function to convert odds ratio SE to variance of R
# Conversion equation from: https://www.meta-analysis.com/downloads/Meta-analysis%20Converting%20among%20effect%20sizes.pdf
OR_to_r_variance <- function(OR, logSE) {
  log_odds = log(OR) # log transform odds ratio 
  d = log_odds * (sqrt(3)/3.14159) # convert log odds to cohen's d
  var_d = logSE^2 * (3 / 3.14159^2) # convert log odds SE to variance of cohen's d
  r = d / sqrt(d^2 + 4) # convert cohen's d to r
  var_r = 4^2 * var_d / (d^2 + 4)^3 # convert cohen's d and variance of d to variance of r
  se_r = sqrt(var_r)
  return(var_r)
}

# Check studies reporting odds ratio
data %>% dplyr::filter (Type_of_effect_size_obj == "odds_ratio") %>% 
  group_by(Author) %>%   summarise(n = n())

# Check studies reporting log odds 
data %>% dplyr::filter (Type_of_effect_size_obj == "log_odds") %>% 
  group_by(Author) %>%   summarise(n = n())

## Convert log odds to odds ratios
# Objective measure
data$Effect_size_obj[data$Type_of_effect_size_obj == "log_odds"] <- 
  exp(data$Effect_size_obj[data$Type_of_effect_size_obj == "log_odds"])
# Subjective measure
data$Effect_size_subj[data$Type_of_effect_size_subj == "log_odds"] <- 
  exp(data$Effect_size_subj[data$Type_of_effect_size_subj == "log_odds"])
# Specify that previous log odds values have now been converted to odds ratios
data$Type_of_effect_size_obj[data$Type_of_effect_size_obj == "log_odds"] <- "odds_ratio"
data$Type_of_effect_size_subj[data$Type_of_effect_size_subj == "log_odds"] <- "odds_ratio"

# Check studies reporting odds ratio
data %>% dplyr::filter (Type_of_effect_size_obj == "odds_ratio") %>% 
  group_by(Author) %>%   summarise(n = n())

# Convert effect sizes for the objective measure 
# Convert effect sizes
data$r_objective_es[data$Type_of_effect_size_obj == "odds_ratio"] <- 
  OR_to_r(OR = data$Effect_size_obj[data$Type_of_effect_size_obj == "odds_ratio"],
          logSE = data$SE_obj[data$Type_of_effect_size_obj == "odds_ratio"])
# Convert SE to variance
data$r_objective_var[data$Type_of_effect_size_obj == "odds_ratio"] <- 
  OR_to_r_variance(OR = data$Effect_size_obj[data$Type_of_effect_size_obj == "odds_ratio"],
                         logSE = data$SE_obj[data$Type_of_effect_size_obj == "odds_ratio"])

# Check results before and after converting
# effect sizes
data$Effect_size_obj[data$Type_of_effect_size_obj == "odds_ratio"] # before converting
data$r_objective_es[data$Type_of_effect_size_obj == "odds_ratio"] # after converting
# variance
data$SE_obj[data$Type_of_effect_size_obj == "odds_ratio"]^2 # var before converting
data$r_objective_var[data$Type_of_effect_size_obj == "odds_ratio"] # after converting

# Repeat for subjective measure
# Convert effect sizes 
data$r_subjective_es[data$Type_of_effect_size_subj == "odds_ratio"] <- 
  OR_to_r(OR = data$Effect_size_subj[data$Type_of_effect_size_subj == "odds_ratio"],
          logSE = data$SE_subj[data$Type_of_effect_size_subj == "odds_ratio"])
# Convert SE to variance
data$r_subjective_var[data$Type_of_effect_size_subj == "odds_ratio"] <- 
  OR_to_r_variance(OR = data$Effect_size_subj[data$Type_of_effect_size_subj == "odds_ratio"],
                   logSE = data$SE_subj[data$Type_of_effect_size_subj == "odds_ratio"])

# Check results before and after converting
# effect sizes
data$Effect_size_subj[data$Type_of_effect_size_subj == "odds_ratio"] # before converting
data$r_subjective_es[data$Type_of_effect_size_subj == "odds_ratio"] # after converting
# variance
data$SE_subj[data$Type_of_effect_size_subj == "odds_ratio"]^2 # var before converting
data$r_subjective_var[data$Type_of_effect_size_subj == "odds_ratio"] # after converting

# P-values 
p_function(data$Effect_size_subj[data$Type_of_effect_size_subj=="odds_ratio"], 
           data$SE_subj[data$Type_of_effect_size_subj=="odds_ratio"]) # before converting to r
p_function(data$r_subjective_es[data$Type_of_effect_size_subj=="odds_ratio"], 
           sqrt(data$r_subjective_var[data$Type_of_effect_size_subj=="odds_ratio"])) # after converting to r

# Check effect sizes left to convert
table(data$Type_of_effect_size_obj[is.na(data$r_objective_es)])
table(data$Type_of_effect_size_subj[is.na(data$r_subjective_es)])
```

###### 2.3.4 Convert unstandardised betas to r

```{r}
# Function to convert unstandardised beta to R
unstand_beta_to_r <- function(beta, SD_exposure, SD_outcome) {
  r = beta * (SD_exposure / SD_outcome)
  return(r)
}

# Function to convert SE of unstandardised beta to variance of R
# Equation: https://stats.stackexchange.com/questions/451358/calculating-the-standard-errors-of-the-standardized-regression-coefficients-from
unstand_beta_to_r_variance <- function(beta, se_beta, SD_exposure, SD_outcome) {
  r = beta * (SD_exposure / SD_outcome)
  se_r = se_beta * (r/beta)
  var_r = se_r^2
  return(var_r)
}

# Check studies reporting unstandardised beta
data %>% dplyr::filter (Type_of_effect_size_obj == "unstandardised_beta") %>% 
  group_by(Author) %>%   summarise(n = n())

# Convert effect sizes for the objective measure 
# Convert effect sizes
data$r_objective_es[data$Type_of_effect_size_obj == "unstandardised_beta"] <- 
  unstand_beta_to_r(beta = data$Effect_size_obj[data$Type_of_effect_size_obj == "unstandardised_beta"],
                    SD_exposure = data$Std_obj[data$Type_of_effect_size_obj == "unstandardised_beta"],
                      SD_outcome = data$SD_Outcome[data$Type_of_effect_size_obj == "unstandardised_beta"])
# Convert SE to variance
data$r_objective_var[data$Type_of_effect_size_obj == "unstandardised_beta"] <- 
  unstand_beta_to_r_variance(beta = data$Effect_size_obj[data$Type_of_effect_size_obj == "unstandardised_beta"],
                             se_beta = data$SE_obj[data$Type_of_effect_size_obj == "unstandardised_beta"],
                             SD_exposure = data$Std_obj[data$Type_of_effect_size_obj == "unstandardised_beta"],
                             SD_outcome = data$SD_Outcome[data$Type_of_effect_size_obj == "unstandardised_beta"])

# Check results before and after converting
# effect sizes
data$Effect_size_obj[data$Type_of_effect_size_obj == "unstandardised_beta"] # before converting
data$r_objective_es[data$Type_of_effect_size_obj == "unstandardised_beta"] # after converting
# variance
data$SE_obj[data$Type_of_effect_size_obj == "unstandardised_beta"]^2 # var before converting
data$r_objective_var[data$Type_of_effect_size_obj == "unstandardised_beta"] # after converting

# Repeat for subjective measure
# Convert effect sizes
data$r_subjective_es[data$Type_of_effect_size_subj == "unstandardised_beta"] <- 
  unstand_beta_to_r(beta = data$Effect_size_subj[data$Type_of_effect_size_subj == "unstandardised_beta"],
                    SD_exposure = data$Std_subj[data$Type_of_effect_size_subj == "unstandardised_beta"],
                    SD_outcome = data$SD_Outcome[data$Type_of_effect_size_subj == "unstandardised_beta"])
# Convert SE to variance
data$r_subjective_var[data$Type_of_effect_size_subj == "unstandardised_beta"] <- 
  unstand_beta_to_r_variance(beta = data$Effect_size_subj[data$Type_of_effect_size_subj == "unstandardised_beta"],
                             se_beta = data$SE_subj[data$Type_of_effect_size_subj == "unstandardised_beta"],
                             SD_exposure = data$Std_subj[data$Type_of_effect_size_subj == "unstandardised_beta"],
                             SD_outcome = data$SD_Outcome[data$Type_of_effect_size_subj == "unstandardised_beta"])

# Check results before and after converting
# effect sizes
data$Effect_size_subj[data$Type_of_effect_size_subj == "unstandardised_beta"] # before converting
data$r_subjective_es[data$Type_of_effect_size_subj == "unstandardised_beta"] # after converting
# variance
data$SE_subj[data$Type_of_effect_size_subj == "unstandardised_beta"]^2 # var before converting
data$r_subjective_var[data$Type_of_effect_size_subj == "unstandardised_beta"] # after converting
```

###### 2.3.5 Convert risk ratios to r

```{r}
# Check studies reporting unstandardised beta
data %>% dplyr::filter (Type_of_effect_size_obj == "risk_ratio") %>% 
  group_by(Author) %>%   summarise(n = n())

## First define function to convert RR to OR
# RR = OR/ (1-p + (p * OR)) 
# OR = ((1 - p) * RR) / (1 - RR * p).
# where RR is the relative risk, OR is the odds ratio, and p is the control event rate
# e.g. the prevalence rate in the non-exposed individuals
# formula recommended by Grant et al., BMJ 2014: https://www.bmj.com/content/348/bmj.f7450
# and referenced in https://www.r-bloggers.com/2014/01/how-to-convert-odds-ratios-to-relative-risks/
# and https://www.researchgate.net/post/Can-we-Convert-Risk-Ratio-to-Odd-Ratios-what-is-the-baseline-risk-p-of-a-selection-of-populations-to-either-suffer-die-from-coronary-heart-disease

RR_to_OR <- function(RR, p) {
  OR <- ((1 - p) * RR) / (1 - RR * p)
  return(OR)
}

RR_to_OR_SE <- function(RR, RR_lowCI, RR_upCI, p) {
  OR <- ((1 - p) * RR) / (1 - RR * p)
  log_OR <- log(OR)
  OR_lowCI <- ((1 - p) * RR_lowCI) / (1 - RR_lowCI * p)
  OR_upperCI <- ((1 - p) * RR_upCI) / (1 - RR_upCI * p)
  log_OR_SE <- (log(OR_upperCI) - log(OR_lowCI))/3.92
  return(log_OR_SE)
}

# Create specific columns for upper and lower CIs for the risk ratios
# Objective
data$lower_CI_obj <- as.numeric(substr(data$CI_obj, 1, 4)) 
data$upper_CI_obj <- as.numeric(substr(data$CI_obj, 6, 10))  
# Subjective
data$lower_CI_subj <- as.numeric(substr(data$CI_subj, 1, 4))  
data$upper_CI_subj <- as.numeric(substr(data$CI_subj, 6, 10)) 

# Add a column with the prevalence of the MH outcome in unexposed participants (e.g., coded as "none" on graphs)
# Tool for calculating prevalence from graphs (specific to the exposure and outcome): https://apps.automeris.io/wpd/

# Step 1. Convert relative risks to odds ratios 
# Objective measures
# Convert RR to odds ratio
data$Effect_size_obj[data$Type_of_effect_size_obj == "risk_ratio"] <- 
  RR_to_OR(RR = data$Effect_size_obj[data$Type_of_effect_size_obj == "risk_ratio"],
           p = data$prevalence_unexposed[data$Type_of_effect_size_obj == "risk_ratio"]) # to change the column name with prevalence in unexposed

# Convert SE of RR to SE of log odds ratio
data$SE_obj[data$Type_of_effect_size_obj == "risk_ratio"] <- 
  RR_to_OR_SE(RR = data$Effect_size_obj[data$Type_of_effect_size_obj == "risk_ratio"],
              RR_lowCI = data$lower_CI_obj[data$Type_of_effect_size_obj == "risk_ratio"],
              RR_upCI = data$upper_CI_obj[data$Type_of_effect_size_obj == "risk_ratio"],
              p = data$prevalence_unexposed[data$Type_of_effect_size_obj == "risk_ratio"]) # to change the column name with prevalence in unexposed
# Specify that effects have been changed to odds ratios
data$Type_of_effect_size_obj[data$Type_of_effect_size_obj == "risk_ratio"] <- "odds_ratio"

# Repeat for subjective measure
# Convert RR to odds ratio
data$Effect_size_subj[data$Type_of_effect_size_subj == "risk_ratio"] <- 
  RR_to_OR(RR = data$Effect_size_subj[data$Type_of_effect_size_subj == "risk_ratio"],
           p = data$prevalence_unexposed[data$Type_of_effect_size_subj == "risk_ratio"]) # to change the column name with prevalence in unexposed
# Convert SE of RR to SE of log odds ratio
data$SE_subj[data$Type_of_effect_size_subj == "risk_ratio"] <- 
  RR_to_OR_SE(RR = data$Effect_size_subj[data$Type_of_effect_size_subj == "risk_ratio"],
              RR_lowCI = data$lower_CI_subj[data$Type_of_effect_size_subj == "risk_ratio"],
              RR_upCI = data$upper_CI_subj[data$Type_of_effect_size_subj == "risk_ratio"],
              p = data$prevalence_unexposed[data$Type_of_effect_size_subj == "risk_ratio"]) # to change the column name with prevalence in unexposed
# Specify that effects have been changed to odds ratios
data$Type_of_effect_size_subj[data$Type_of_effect_size_subj == "risk_ratio"] <- "odds_ratio"

## Step 2. Convert odds ratios to correlation coefficients
# Convert objective effect sizes 
data$r_objective_es[data$Type_of_effect_size_obj == "odds_ratio"] <- 
  OR_to_r(OR = data$Effect_size_obj[data$Type_of_effect_size_obj == "odds_ratio"],
          logSE = data$SE_obj[data$Type_of_effect_size_obj == "odds_ratio"])
# Convert SE to variance
data$r_objective_var[data$Type_of_effect_size_obj == "odds_ratio"] <- 
  OR_to_r_variance(OR = data$Effect_size_obj[data$Type_of_effect_size_obj == "odds_ratio"],
                   logSE = data$SE_obj[data$Type_of_effect_size_obj == "odds_ratio"])
mean(data$r_objective_es[!is.na(data$r_objective_es)])

# Convert subjective effect sizes 
data$r_subjective_es[data$Type_of_effect_size_subj == "odds_ratio"] <- 
  OR_to_r(OR = data$Effect_size_subj[data$Type_of_effect_size_subj == "odds_ratio"],
          logSE = data$SE_subj[data$Type_of_effect_size_subj == "odds_ratio"])
# Convert SE to variance
data$r_subjective_var[data$Type_of_effect_size_subj == "odds_ratio"] <- 
  OR_to_r_variance(OR = data$Effect_size_subj[data$Type_of_effect_size_subj == "odds_ratio"],
                   logSE = data$SE_subj[data$Type_of_effect_size_subj == "odds_ratio"])

```

###### 2.3.6 Convert r to Fisher's Z

```{r}
# Convert r to Fishers-Z
# Formula: z_r = tanh^{-1}(r) = \frac{1}{2}log≤ft ( \frac{1+r}{1-r}\right )
# From: https://rdrr.io/cran/DescTools/man/FisherZ.html

# Create new variables for Fishers-Z conversion
data$z_r_subj <- NA
data$z_r_obj <- NA

# Convert subjective measure correlations to fishersz
data$z_r_subj <- fisherz(data$r_subjective_es)
# Compare variables for subjective effect sizes
list(data$z_r_subj)
list(data$r_subjective_es)

# Convert objective measure correlations to fishersz
data$z_r_obj <-fisherz(data$r_objective_es)
# Compare variables for objective effect sizes
list(data$z_r_obj)
list(data$r_objective_es)

# Derive variables for variance of Fisher's Z
data$z_var_subj <- NA
data$z_var_obj <- NA

# Calculate variance of Fisher's Z
data$z_var_subj <- 1 / (data$Subj_vs_none-3) 
data$z_var_obj <- 1 / (data$Obj_vs_none-3)

mean(data$z_r_subj[!is.na(data$z_r_subj)])
mean(data$z_r_obj[!is.na(data$z_r_obj)])

library(metafor)
data$es_id <- 1:nrow(data)
data$ref <- paste0(data$Author, "_", data$Year)
data$cohort_name <- paste0(data$Cohort)

# Check included studies
data %>% dplyr::filter (!is.na(z_r_subj) & !is.na(z_var_subj)) %>%
  dplyr::select(ref, cohort_name)
```

##### 2.4 Descriptive statistics

```{r}
# Number of studies
k_studies <- data %>%
  group_by(Author) %>%
  dplyr::summarise(m = max(Author)) %>% nrow()
k_studies

# Number of cohorts
k_cohort <- data %>%
  group_by(cohort_name) %>%
  dplyr::summarise(m = max(cohort_name)) %>% nrow()
k_cohort

# Total sample size
data %>%
  group_by(cohort_name) %>%
  dplyr::summarise(m = max(N_Included))%>%
  dplyr::summarise(sum = sum(m))

# Average proportion female
perc_female <- data %>%
  group_by(cohort_name) %>%
  dplyr::summarise(mean_percent_female = mean(percent_female)) %>%
  dplyr::summarise(overall=mean(mean_percent_female, na.rm=TRUE))
perc_female

# Age at self-reported adversity
Age_self <- data %>%
  group_by(cohort_name) %>%
  dplyr::summarise(mean_age_self = mean(Age_self)) %>%
  dplyr::summarise(overall=mean(mean_age_self, na.rm=TRUE))
Age_self
describe(data$Age_self)

# Number of effect sizes
n_es_obj <- length(data$r_objective_es[!is.na(data$r_objective_es)])
n_es_obj

n_es_subj<-length(data$r_subjective_es[!is.na(data$r_subjective_es)])
n_es_subj

# Effect sizes by exposure type
# Maltreatment
n_es_obj_mal <- length(data$r_objective_es[!is.na(data$r_objective_es) & data$exposure_type_broad=="maltreatment"])
n_es_obj_mal*2

n_es_subj_mal <- length(data$r_subjective_es[!is.na(data$r_subjective_es) & data$exposure_type_broad=="maltreatment"])
n_es_subj_mal

# Bullying
n_es_obj_bully <- length(data$r_objective_es[!is.na(data$r_objective_es) & data$exposure_type_broad=="bullying"])
n_es_obj_bully*2

n_es_subj_bully <- length(data$r_subjective_es[!is.na(data$r_subjective_es) & data$exposure_type_broad=="bullying"])
n_es_subj_bully

# Neighbourhood
n_es_obj_neigh <- length(data$r_objective_es[!is.na(data$r_objective_es) & data$exposure_type_broad=="neighbourhood"])
n_es_obj_neigh

n_es_subj_neigh <- length(data$r_subjective_es[!is.na(data$r_subjective_es) & data$exposure_type_broad=="neighbourhood"])
n_es_subj_neigh

# Number of studies by adversity
# Maltreatment
k_studies <- data %>%
  group_by(Author) %>%
  filter(exposure_type_broad=="maltreatment") %>%
  dplyr::summarise(m = max(Author)) %>% nrow()
k_studies

# Bullying
k_studies <- data %>%
  group_by(Author) %>%
  filter(exposure_type_broad=="bullying") %>%
  dplyr::summarise(m = max(Author)) %>% nrow()
k_studies

# Neighbourhood
k_studies <- data %>%
  group_by(Author) %>%
  filter(exposure_type_broad=="neighbourhood") %>%
  dplyr::summarise(m = max(Author)) %>% nrow()
k_studies
```

##### 2.5 Do objective and subjective measures of childhood adversity independently predict psychopathology?

###### 2.5.1 Maltreatment

```{r}
# Check included studies & cohorts
data %>% dplyr::filter (!is.na(z_r_subj) & !is.na(z_var_subj) & exposure_type_broad=="maltreatment") %>%
  dplyr::select(ref, cohort_name)

# Subjective
subj_maltreatment <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref,  ~ 1 | cohort_name),
                            data = data, subset=exposure_type_broad=="maltreatment" & !is.na(exposure_type_broad), slab=paste(ref, es_id, sep=", "))
subj_maltreatment
round(fisherz2r(c(subj_maltreatment$beta, subj_maltreatment$ci.lb, subj_maltreatment$ci.ub)),2)

# Objective 
obj_maltreatment <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref,  ~ 1 | cohort_name),
                           data = data, subset=exposure_type_broad=="maltreatment" & !is.na(exposure_type_broad), slab=paste(ref, es_id, sep=", "))
obj_maltreatment
round(fisherz2r(c(obj_maltreatment$beta, obj_maltreatment$ci.lb, obj_maltreatment$ci.ub)),2)
```

###### 2.5.2 Bullying

```{r}
# Check included studies & cohorts
data %>% dplyr::filter (!is.na(z_r_subj) & !is.na(z_var_subj) & exposure_type_broad=="bullying") %>%
  dplyr::select(ref, cohort_name)

# Subjective 
subj_bullying <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref,  ~ 1 | cohort_name),
                        data = data, subset=exposure_type_broad=="bullying" & !is.na(exposure_type_broad), slab=paste(ref, es_id, sep=", "))
subj_bullying
round(fisherz2r(c(subj_bullying$beta, subj_bullying$ci.lb, subj_bullying$ci.ub)),2)

# Objective 
obj_bullying <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref,  ~ 1 | cohort_name),
                       data = data, subset=exposure_type_broad=="bullying" & !is.na(exposure_type_broad), slab=paste(ref, es_id, sep=", "))
obj_bullying
round(fisherz2r(c(obj_bullying$beta, obj_bullying$ci.lb, obj_bullying$ci.ub)),2)
```

###### 2.5.3 Neighbourhood

```{r}
# Subjective 
subj_neighbour<- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref),
                        data = data, subset=exposure_type_broad=="neighbourhood" & !is.na(exposure_type_broad), slab=paste(ref, es_id, sep=", "))
subj_neighbour
round(fisherz2r(c(subj_neighbour$beta, subj_neighbour$ci.lb, subj_neighbour$ci.ub)),2)

# Objective
obj_neighbour <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref),
                        data = data, subset=exposure_type_broad=="neighbourhood" & !is.na(exposure_type_broad), slab=paste(ref, es_id, sep=", "))
obj_neighbour
round(fisherz2r(c(obj_neighbour$beta, obj_neighbour$ci.lb, obj_neighbour$ci.ub)),2)
```

###### 2.5.4 Comparing Estimates of Independent Meta-Analyses or Subgroups

```{r}
## Comparing effect sizes from neighbourhood objective & subjective meta-analyses
# Example: https://www.metafor-project.org/doku.php/tips:comp_two_independent_estimates 
# subj_neighbour Subjective meta-analysis
# obj_neighbour Objective meta-analysis

# Fit two separate random-effects models within each subset - define by subsetting
res1 <- rma(z_r_subj, z_var_subj, data=data, subset=Subj_type_neigh=="self_report")
res2 <- rma(z_r_obj, z_var_obj, data=data, subset=Obj_type_neigh=="records")

# Combine estimates and standard errors from each model (effect of subjective measures, 
# then effect of objective measures) into a data frame
dat.comp <- data.frame(estimate = c(coef(obj_neighbour), coef(subj_neighbour)), 
                       stderror = c(obj_neighbour$se, subj_neighbour$se),
                       meta = c("records", "self_report"), tau2 = round(c(obj_neighbour$tau2, subj_neighbour$tau2),3))
dat.comp

# Compare the two estimates by feeding them back to the rma() function and 
# using the variable to distinguish the two estimates as a moderator
rma(estimate, sei=stderror, mods = ~ meta, method="FE", data=dat.comp, digits=3)
```

###### 2.5.5 Wald-type test for confirmation

```{r}
with(dat.comp, round(c(zval = (estimate[1] - estimate[2])/sqrt(stderror[1]^2 + stderror[2]^2)), 3))
```

##### 2.6 Forest plots for meta-analysis

###### 2.6.1 Subjective Maltreatment

```{r}
maltreatment_data <- subset(data, exposure_type_broad=="maltreatment")
maltreatment_data2 <- maltreatment_data[order(maltreatment_data$Author, maltreatment_data$Year),] #re-order
maltreatment_data2$refPlot <- paste0(maltreatment_data2$Author, " ", maltreatment_data2$Year)

# Remove underscores
maltreatment_data2$MH_Outcome <- gsub("_Symptoms","", maltreatment_data2$MH_Outcome)
maltreatment_data2$MH_Outcome <- gsub("_Diagnosis","", maltreatment_data2$MH_Outcome)

maltreatment_data2$MH_Outcome

maltreatment_data2$Exposure_Type_Subj <- gsub("_"," ", maltreatment_data2$Exposure_Type_Subj)
maltreatment_data2$MH_Outcome <- gsub("_"," ", maltreatment_data2$MH_Outcome)

maltreatment_data2$Exposure_Type_Subj

# Run meta-analysis again - subjective
subj_maltreatment <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref,  ~ 1 | cohort_name),
                            data = maltreatment_data2, subset=exposure_type_broad=="maltreatment" & !is.na(exposure_type_broad), 
                            slab=paste(ref, es_id, sep=", "))
subj_maltreatment

# Subjective malteatment - forest plot
forest(subj_maltreatment,
       transf=transf.ztor, 
       order = order(maltreatment_data2$Author, maltreatment_data2$Year), 
        xlim=c(-2.0, 1.5),at=c(-0.8, -0.6,-0.4,-0.2,0,0.2,0.4,0.6,0.8,1), 
       xlab = "Correlation",
       mlab="Multivariate Meta-Analysis Model", 
       #header=c("Author", "Year", "Correlation"),
       slab=NA, 
       ilab=cbind(maltreatment_data2$refPlot, maltreatment_data2$Exposure_Type_Subj, maltreatment_data2$MH_Outcome), 
       ilab.xpos=c(-2.0, -1.55, -1.1), cex=0.35, 
       ilab.pos = c(4, 4, 4, 4),
       top=2) 
par(font=2)
text(c(-1.86, -1.38, -1.0, 1.33), 97, c("Reference", "Maltreatment type", "Outcome", "Correlation [95% CI]"), cex=0.4)
```

###### 2.6.2 Objective Maltreatment

```{r}
# Remove underscores
maltreatment_data2$Exposure_Type_Obj <- gsub("_"," ", maltreatment_data$Exposure_Type_Obj)
maltreatment_data2$MH_Outcome <- gsub("_"," ", maltreatment_data2$MH_Outcome) #re-order
maltreatment_data2$refPlot <- paste0(maltreatment_data2$Author, " ", maltreatment_data2$Year)

maltreatment_data2$Exposure_Type_Obj
maltreatment_data2$MH_Outcome

# Run meta-analysis again - objective
obj_maltreatment2 <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref,  ~ 1 | cohort_name),
                                 data = maltreatment_data2, subset=exposure_type_broad=="maltreatment" & !is.na(exposure_type_broad), 
                                 slab=paste(ref, es_id, sep=", "))
obj_maltreatment2

# Objective malteatment - forest plot
forest(obj_maltreatment2,
            order = order(maltreatment_data2$Author, maltreatment_data2$Year),
            transf=transf.ztor, 
            # order studies from earliest to latest date
             xlim=c(-2.2, 1.5), at=c(-0.6,-0.4,-0.2,0,0.2,0.4,0.6), 
             xlab = "Correlation",
             mlab="Multivariate Meta-Analysis Model",
             #header=c("Author", "Year", "Correlation"),e
             slab=NA, 
             ilab=cbind(maltreatment_data2$refPlot, maltreatment_data2$Exposure_Type_Obj, maltreatment_data2$MH_Outcome), 
             ilab.xpos=c(-2.2, -1.7, -1.16), cex=0.38,
             ilab.pos=c(4, 4, 4, 4),
             top=2) 
      par(font=2)
      text(c(-2.1, -1.51, -1.05, 1.3), 97, c("Reference", "Maltreatment type", "Outcome", "Correlation [95% CI]"), cex=0.4)
```

###### 2.6.3 Subjective Bullying

```{r}
bullying_data <- subset(data, exposure_type_broad=="bullying")
bullying_data2 <- bullying_data[order(bullying_data$Author, bullying_data$Year),] #re-order
bullying_data2$refPlot <- paste0(bullying_data2$Author, " ", bullying_data2$Year)

# Remove underscores
bullying_data2$MH_Outcome <- gsub("_Symptoms","", bullying_data2$MH_Outcome)
bullying_data2$MH_Outcome <- gsub("_Diagnosis","", bullying_data2$MH_Outcome)

bullying_data2$MH_Outcome

bullying_data2$Exposure_Type_Subj <- gsub("_"," ", bullying_data2$Exposure_Type_Subj)
bullying_data2$MH_Outcome <- gsub("_"," ", bullying_data2$MH_Outcome)

bullying_data2$Exposure_Type_Subj

bullying_data2$Author <- gsub("_"," ", bullying_data2$Author)

# Run meta-analysis again - subjective
subj_bullying2 <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref,  ~ 1 | cohort_name),
                         data = bullying_data2, subset=exposure_type_broad=="bullying" & !is.na(exposure_type_broad), 
                         slab=paste(ref, es_id, sep=", "))
subj_bullying2

# Subjective bullying - forest plot
forest(subj_bullying2, 
       order = order(bullying_data2$Author, bullying_data2$Year), 
       transf=transf.ztor, 
       xlim=c(-2.0, 1.5), at=c(-0.2,0,0.2,0.4,0.6), 
       xlab = "Correlation", 
       mlab="Multivariate Meta-Analysis Model", 
       #header=c("Author", "Year", "Fishers-Z"),
       slab=NA, 
       ilab=cbind(bullying_data2$refPlot, bullying_data2$Exposure_Type_Subj, bullying_data2$MH_Outcome), 
       ilab.xpos=c(-2.0, -1.3, -0.7), cex=0.4, 
       ilab.pos = c(4, 4, 4, 4),
       top=2) 
par(font=2)
text(c(-1.82, -1.05, -0.55, 1.27), 47, c("Reference", "Bullying type", "Outcome", "Correlation [95% CI]"), cex=0.4)
```

###### 2.6.4 Objective Bullying

```{r}
# Remove underscores
bullying_data2$Exposure_Type_Obj <- gsub("_"," ", bullying_data2$Exposure_Type_Obj)
bullying_data2$MH_Outcome <- gsub("_"," ", bullying_data2$MH_Outcome)
bullying_data2$refPlot <- paste0(bullying_data2$Author, " ", bullying_data2$Year)

bullying_data2$Exposure_Type_Obj
bullying_data2$MH_Outcome

# Run meta-analysis again - objective
obj_bullying2 <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref,  ~ 1 | cohort_name),
                        data = bullying_data2, subset=exposure_type_broad=="bullying" & !is.na(exposure_type_broad), 
                        slab=paste(ref, es_id, sep=", "))
obj_bullying2

# Objective bullying - forest plot
forest(obj_bullying2,
       order = order(bullying_data2$Author, bullying_data2$Year),
       transf=transf.ztor, 
       xlim=c(-1.5, 0.9), at=c(-0.4,-0.2,0,0.2,0.4,0.6), 
       xlab = "Correlation", 
       mlab="Multivariate Meta-Analysis Model",
       slab=NA, 
      ilab=cbind(bullying_data2$refPlot, bullying_data2$Exposure_Type_Obj, bullying_data2$MH_Outcome), 
       ilab.xpos=c(-1.5, -1.0, -0.55), cex=0.35, 
       ilab.pos=c(4, 4, 4, 4),
       top=3)
par(font=2)
text(c(-1.37, -0.85, -0.45, 0.75), 47, c("Reference", "Bullying type", "Outcome", "Correlation [95% CI]"), cex=0.4)
```

###### 2.6.5 Subjective Neighbourhood

```{r}
neighbour_data <- subset(data, exposure_type_broad=="neighbourhood")
neighbour_data2 <- neighbour_data[order(neighbour_data$Author, neighbour_data$Year),] #re-order
neighbour_data2$refPlot <- paste0(neighbour_data2$Author, " ", neighbour_data2$Year)

# Remove underscores
neighbour_data2$MH_Outcome <- gsub("_Symptoms","", neighbour_data2$MH_Outcome)
neighbour_data2$MH_Outcome <- gsub("_Diagnosis","", neighbour_data2$MH_Outcome)

neighbour_data2$Exposure_Type_Subj <- gsub("_"," ", neighbour_data2$Exposure_Type_Subj)
neighbour_data2$MH_Outcome <- gsub("_"," ", neighbour_data2$MH_Outcome)
      
neighbour_data2$Exposure_Type_Subj
neighbour_data2$MH_Outcome

# Run meta-analysis again - sujective
subj_neighbour2<- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref),
                        data = neighbour_data2, subset=exposure_type_broad=="neighbourhood" & !is.na(exposure_type_broad))

subj_neighbour2

# Subjective neighbourhood - forest plot
forest(subj_neighbour2,
       order = order(neighbour_data2$Year, neighbour_data2$Author), 
       transf=transf.ztor, 
       xlim=c(-1.5, 0.9), at=c(-0.2,0,0.2,0.4,0.6), 
       xlab = "Correlation",
       mlab="Multivariate Meta-Analysis Model", 
       slab=NA, 
       ilab=cbind(neighbour_data2$refPlot, neighbour_data2$Exposure_Type_Subj, neighbour_data2$MH_Outcome),
       ilab.xpos=c(-1.52, -1.1, -0.7), cex=0.4, 
       ilab.pos = c(4, 4, 4, 4),
       top=3) 
par(font=2)
text(c(-1.39, -0.96, -0.6, 0.75), 3.2, c("Reference", "Neighbourhood type", "Outcome", "Correlation [95% CI]"), cex=0.4)
```

###### 2.6.6 Objective Neighbourhood

```{r}
# Remove underscores
neighbour_data$Exposure_Type_Obj <- gsub("_"," ", neighbour_data$Exposure_Type_Obj)
neighbour_data$MH_Outcome <- gsub("_"," ", neighbour_data$MH_Outcome)
neighbour_data2$refPlot <- paste0(neighbour_data2$Author, " ", neighbour_data2$Year)

neighbour_data2$Exposure_Type_Obj

# Run meta-analysis again - objective
obj_neighbour2<- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref),
                        data = neighbour_data2, subset=exposure_type_broad=="neighbourhood" & !is.na(exposure_type_broad))

obj_neighbour2

# Objective neighbourhood - forest plot
forest(obj_neighbour2, 
       order = order(neighbour_data2$Year, neighbour_data2$Author), 
       transf=transf.ztor,
       xlim=c(-1.5, 1.0), at=c(-0.2,0,0.2,0.4,0.6), 
       xlab = "Correlation", 
       mlab="Multivariate Meta-Analysis Model", 
       slab=NA, 
       ilab=cbind(neighbour_data2$refPlot, neighbour_data2$Exposure_Type_Obj, neighbour_data2$MH_Outcome), 
       ilab.xpos=c(-1.5, -1.05, -0.6), cex=0.5, 
       ilab.pos = c(4, 4, 4, 4),
       top=3) 
par(font=2)
text(c(-1.38, -0.87, -0.48, 0.85), 4.2, c("Reference", "Neighbourhood type", "Outcome", "Correlation [95% CI]"), cex=0.5)
```

###### 2.6.7 Combined Subjective and Objective Maltreatment
```{r}
library(metafor)

maltreatment_data <- subset(data, exposure_type_broad=="maltreatment")
# combine author and year into a single variable
maltreatment_data2$refPlot <- paste0(maltreatment_data2$Author, " ", maltreatment_data2$Year)

# Remove underscores
maltreatment_data2$MH_Outcome <- gsub("_Symptoms","", maltreatment_data2$MH_Outcome)
maltreatment_data2$MH_Outcome <- gsub("_Diagnosis","", maltreatment_data2$MH_Outcome)
maltreatment_data2$MH_Outcome
maltreatment_data2$Exposure_Type_Subj <- gsub("_"," ", maltreatment_data2$Exposure_Type_Subj)
maltreatment_data2$MH_Outcome <- gsub("_"," ", maltreatment_data2$MH_Outcome)

maltreatment_data2$Exposure_Type_Subj

# set layout of the plot
layout.matrix <- matrix(c(1,2), nrow = 1, ncol = 2)

layout(mat = layout.matrix,
       heights = c(1), # Heights of the two rows
       widths = c(3.5, 2)) # Widths of the two columns

layout.show(2)

#par(mfrow=c(1,2))
par(mar=c(4,4,1,1))
plot<-forest(subj_maltreatment,
       transf=transf.ztor, 
       order = order(maltreatment_data2$Author, maltreatment_data2$Year), 
       xlim=c(-2, 1.5),at=c(-0.8,-0.6,-0.4,-0.2,0,0.2,0.4,0.6,0.8), 
       xlab = "Correlation",
       mlab="Multivariate Meta-Analysis Model", 
       #header=c("Author", "Year", "Correlation"),
       slab=NA, 
       ilab=cbind(maltreatment_data2$refPlot, maltreatment_data2$Exposure_Type_Subj, maltreatment_data2$MH_Outcome), 
       ilab.xpos=c(-2.0, -1.59, -1.1), 
       cex=0.35, 
       ilab.pos = c(4, 4, 4),
       textpos=c(-2, 1.2),
       top=2) 
par(font=2)
text(c(-1.86, -1.38, -1.0, 1.05), 97, c("Reference", "Maltreatment type", "Outcome", "Correlation [95% CI]"), cex=0.4)
text(0, 97, "A. Subjective measure of maltreatment", cex=.4, font=2)

par(mar=c(4,3,1,2))
forest(obj_maltreatment2,
       order = order(maltreatment_data2$Author, maltreatment_data2$Year),
       transf=transf.ztor, 
       # order studies from earliest to latest date
       xlim=c(1, 1.6), at=c(-0.8,-0.6,-0.4,-0.2,0,0.2,0.4,0.6, 0.8),
       xlab = "Correlation",
       mlab="",
       #header=c("Author", "Year", "Correlation"),e
       slab=NA,
       ilab.xpos=c(-1.2), cex=0.38,
       ilab.pos=c(4),
       textpos=c(-2, 1.4),
       top=2) 
par(font=2)
text(c(1.15), 97, c("Correlation [95% CI]"), cex=0.4)
text(0, 97, "B. Objective measure of maltreatment", cex=.4, font=2)
```

######  2.6.8 Combined Subjective and Objective Bullying
```{r}
bullying_data <- subset(data, exposure_type_broad=="bullying")

# Remove underscores
bullying_data2$MH_Outcome <- gsub("_Symptoms","", bullying_data2$MH_Outcome)
bullying_data2$MH_Outcome <- gsub("_Diagnosis","", bullying_data2$MH_Outcome)

bullying_data2$MH_Outcome

bullying_data2$Exposure_Type_Subj <- gsub("_"," ", bullying_data2$Exposure_Type_Subj)
bullying_data2$MH_Outcome <- gsub("_"," ", bullying_data2$MH_Outcome)

bullying_data2$Exposure_Type_Subj

bullying_data2$Author <- gsub("_"," ", bullying_data2$Author)

# combine author and year into a single variable
bullying_data2$refPlot <- paste0(bullying_data2$Author, " ", bullying_data2$Year)

library(metafor)

# set layout of the plot
layout.matrix <- matrix(c(1,2), nrow = 1, ncol = 2)

layout(mat = layout.matrix,
       heights = c(1), # Heights of the two rows
       widths = c(3.5, 2)) # Widths of the two columns

layout.show(2)

#par(mfrow=c(1,2))
par(mar=c(4,4,1,1))
plot<-forest(subj_bullying2,
       transf=transf.ztor, 
       order = order(bullying_data2$Author, bullying_data2$Year), 
       xlim=c(-2, 1.5),at=c(-0.8,-0.6,-0.4,-0.2,0,0.2,0.4,0.6,0.8), 
       xlab = "Correlation",
       mlab="Multivariate Meta-Analysis Model", 
       #header=c("Author", "Year", "Correlation"),
       slab=NA, 
       ilab=cbind(bullying_data2$refPlot, bullying_data2$Exposure_Type_Subj, bullying_data2$MH_Outcome), 
       ilab.xpos=c(-2.0, -1.48, -1.05), 
       cex=0.35, 
       ilab.pos = c(4, 4, 4),
       textpos=c(-2, 1.2),
       top=2) 
par(font=2)
text(c(-1.86, -1.3, -0.9, 1.05), 47, c("Reference", "Bullying type", "Outcome", "Correlation [95% CI]"), cex=0.4)
text(0, 47, "A. Subjective measure of bullying", cex=.4, font=2)

par(mar=c(4,3,1,2))
forest(obj_bullying2,
       order = order(bullying_data2$Author, bullying_data2$Year),
       transf=transf.ztor, 
       # order studies from earliest to latest date
       xlim=c(1, 1.5), at=c(-0.8,-0.6,-0.4,-0.2,0,0.2,0.4,0.6, 0.8), 
       xlab = "Correlation",
       mlab="",
       #header=c("Author", "Year", "Correlation"),e
       slab=NA,
       ilab.xpos=c(-1.2), cex=0.38,
       ilab.pos=c(4),
       textpos=c(-2, 1.4),
       top=2) 
par(font=2)
text(c(1.2), 47, c("Correlation [95% CI]"), cex=0.4)
text(0, 47, "B. Objective measure of bullying", cex=.4, font=2)
```

###### 2.6.9 Combined Subjective and Objective Neighbourhood
```{r}
neighbour_data <- subset(data, exposure_type_broad=="neighbourhood")
# Remove underscores
neighbour_data2$MH_Outcome <- gsub("_Symptoms","", neighbour_data2$MH_Outcome)
neighbour_data2$MH_Outcome <- gsub("_Diagnosis","", neighbour_data2$MH_Outcome)

neighbour_data2$Exposure_Type_Subj <- gsub("_"," ", neighbour_data2$Exposure_Type_Subj)
neighbour_data2$MH_Outcome <- gsub("_"," ", neighbour_data2$MH_Outcome)
      
neighbour_data2$Exposure_Type_Subj
neighbour_data2$MH_Outcome

# combine author and year into a single variable
neighbour_data2$refPlot <- paste0(neighbour_data2$Author, " ", neighbour_data2$Year)

library(metafor)

# set layout of the plot
layout.matrix <- matrix(c(1,2), nrow = 1, ncol = 2)

layout(mat = layout.matrix,
       heights = c(1), # Heights of the two rows
       widths = c(3.5, 2)) # Widths of the two columns

layout.show(2)

#par(mfrow=c(1,2))
par(mar=c(4,4,1,1))
plot<-forest(subj_neighbour2,
       transf=transf.ztor, 
       order = order(neighbour_data2$Author, neighbour_data2$Year), 
         xlim=c(-2.0, 1.9), at=c(-0.4,-0.2,0,0.2,0.4), 
       xlab = "Correlation",
       mlab="Multivariate Meta-Analysis Model", 
       #header=c("Author", "Year", "Correlation"),
       slab=NA, 
       ilab=cbind(neighbour_data2$refPlot, neighbour_data2$Exposure_Type_Subj, neighbour_data2$MH_Outcome), 
       ilab.xpos=c(-2.0, -1.4, -0.85), 
       cex=0.5, 
       ilab.pos = c(4, 4, 4),
       textpos=c(-2, 1.2),
       top=2) 
par(font=2)
text(c(-1.8, -1.17, -0.7, 1.05), 3.3, c("Reference", "Neighbourhood type", "Outcome", "Correlation [95% CI]"), cex=0.5)
text(0, 3.3, "A. Subjective measure of neighbourhood", cex=.5, font=2)

par(mar=c(4,3,1,2))
forest(obj_neighbour2,
       order = order(neighbour_data2$Author, neighbour_data2$Year),
       transf=transf.ztor, 
       # order studies from earliest to latest date
         xlim=c(1, 1.9), at=c(-0.4,-0.2,0,0.2,0.4), 
       xlab = "Correlation",
       mlab="",
       #header=c("Author", "Year", "Correlation"),e
       slab=NA,
       ilab.xpos=c(-1.2), 
       cex=0.5,
       ilab.pos=c(4),
       textpos=c(-2, 1.7),
       top=2) 
par(font=2)
text(c(1.5), 3.3, c("Correlation [95% CI]"), cex=0.5)
text(0, 3.3, "B. Objective measure of neighbourhood", cex=.5, font=2)
```
##### 2.7 What moderates the independent associations between objective and subjective measure of childhood adversity and psychopathology?

##### 2.7.1 Combining moderation analyses for maltreatment & bullying

```{r}
###### Informant for mental health #######
# Code as self vs other
data$Informant_MH_binary <- NA
data$Informant_MH_binary <- "self"
data$Informant_MH_binary[data$Informant_MH!="self-report"] <- "other"

## Subjective measure 
# test for overall moderation (QM, QM p value)
subj_mod_inform <- rma.mv(z_r_subj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                          data = data, mods = ~ Informant_MH_binary, subset=exposure_type_broad!="neighbourhood")
subj_mod_inform

# remove intercept to get effect sizes for each level
subj_mod_inform <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                   data = data, mods = ~ Informant_MH_binary -1, subset=exposure_type_broad!="neighbourhood")
subj_mod_inform

# Convert back to r 
round(fisherz2r(c(subj_mod_inform$beta[2], subj_mod_inform$ci.lb[2], subj_mod_inform$ci.ub[2])),2) #self-report
round(fisherz2r(c(subj_mod_inform$beta[1], subj_mod_inform$ci.lb[1], subj_mod_inform$ci.ub[1])),2) #other

## Objective measure 
# test for overall moderation (QM, QM p value)
obj_mod_inform <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                  data = data, mods = ~ Informant_MH_binary, subset=exposure_type_broad!="neighbourhood")
obj_mod_inform
# remove intercept to get effect sizes for each level
obj_mod_inform <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                         data = data, mods = ~ Informant_MH_binary -1, subset=exposure_type_broad!="neighbourhood")
obj_mod_inform
# Convert back to r 
round(fisherz2r(c(obj_mod_inform$beta[2], obj_mod_inform$ci.lb[2], obj_mod_inform$ci.ub[2])),2) #self-report
round(fisherz2r(c(obj_mod_inform$beta[1], obj_mod_inform$ci.lb[1], obj_mod_inform$ci.ub[1])),2) #other

# N studies
data %>% 
  filter(exposure_type_broad!="neighbourhood") %>%
  count(ref, Informant_MH_binary) %>%
  group_by(Informant_MH_binary) %>% count(Informant_MH_binary)

# No. ES
table(data$Informant_MH_binary[data$exposure_type_broad!="neighbourhood"])

###### Cross-sectional vs longitudinal study #######
# Derive variable for cross-sectional v longitudinal study
data$StudyDesign <- NA
data$StudyDesign[data$Q_Longitud==0] <- "cross-sectional"
data$StudyDesign[data$Q_Longitud==1] <- "longitudinal"

## Subjective measure 
# test for overall moderation (QM, QM p value)
subj_mod_longvcross <- rma.mv(z_r_subj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                          data = data, mods = ~ StudyDesign, subset=exposure_type_broad!="neighbourhood")
subj_mod_longvcross

# remove intercept to get effect sizes for each level
subj_mod_longvcross <- rma.mv(z_r_subj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                          data = data, mods = ~ StudyDesign-1, subset=exposure_type_broad!="neighbourhood")
subj_mod_longvcross
# Convert back to r 
round(fisherz2r(c(subj_mod_longvcross$beta[1], subj_mod_longvcross$ci.lb[1], subj_mod_longvcross$ci.ub[1])),2) #cross-sectional
round(fisherz2r(c(subj_mod_longvcross$beta[2], subj_mod_longvcross$ci.lb[2], subj_mod_longvcross$ci.ub[2])),2) #longitudinal

## Objective measure 
# test for overall moderation (QM, QM p value)
obj_mod_longvcross <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                          data = data, mods = ~ StudyDesign, subset=exposure_type_broad!="neighbourhood")
obj_mod_longvcross

# remove intercept to get effect sizes for each level
obj_mod_longvcross <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                          data = data, mods = ~ StudyDesign-1, subset=exposure_type_broad!="neighbourhood")
obj_mod_longvcross
# Convert back to r 
round(fisherz2r(c(obj_mod_longvcross$beta[1], obj_mod_longvcross$ci.lb[1], obj_mod_longvcross$ci.ub[1])),2) #cross-sectional
round(fisherz2r(c(obj_mod_longvcross$beta[2], obj_mod_longvcross$ci.lb[2], obj_mod_longvcross$ci.ub[2])),2) #longitudinal

# N studies
data %>% 
  filter(exposure_type_broad!="neighbourhood") %>%
  count(ref, Q_Longitud) %>%
  group_by(Q_Longitud) %>% count(Q_Longitud)

# No. ES
table(data$Q_Longitud[data$exposure_type_broad!="neighbourhood"])

###### Type of psychopathology #######
# Note: exclude psychotic experiences as only reported by one study
## Subjective measures
# test for overall moderation (QM, QM p value)
rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       mods=~MHoutcome_broad, data = data, subset=exposure_type_broad!="neighbourhood" &
         MHoutcome_broad!="psychotic_experiences")
# remove intercept to get effect sizes for each level
subj_mod_psychtype <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                   data = data, mods = ~ MHoutcome_broad -1, subset=exposure_type_broad!="neighbourhood" &
         MHoutcome_broad!="psychotic_experiences")
subj_mod_psychtype

# Convert back to r 
round(fisherz2r(c(subj_mod_psychtype$beta[2], subj_mod_psychtype$ci.lb[2], subj_mod_psychtype$ci.ub[2])),2) #internalising
round(fisherz2r(c(subj_mod_psychtype$beta[1], subj_mod_psychtype$ci.lb[1], subj_mod_psychtype$ci.ub[1])),2) #externalising

## Objective measures
# test for overall moderation (QM, QM p value)
rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       mods=~MHoutcome_broad, data = data, subset=exposure_type_broad!="neighbourhood" &
         MHoutcome_broad!="psychotic_experiences")
# remove intercept to get effect sizes for each level
obj_mod_psychtype <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       mods=~MHoutcome_broad-1, data = data, subset=exposure_type_broad!="neighbourhood" &
         MHoutcome_broad!="psychotic_experiences")
obj_mod_psychtype
# Convert back to r 
round(fisherz2r(c(obj_mod_psychtype$beta[2], obj_mod_psychtype$ci.lb[2], obj_mod_psychtype$ci.ub[2])),2) #internalising
round(fisherz2r(c(obj_mod_psychtype$beta[1], obj_mod_psychtype$ci.lb[1], obj_mod_psychtype$ci.ub[1])),2) #externalising

# N studies
data %>% 
  filter(exposure_type_broad!="neighbourhood") %>%
  count(ref, MHoutcome_broad) %>%
  group_by(MHoutcome_broad) %>% count(MHoutcome_broad)

# No. ES
table(data$MHoutcome_broad[data$exposure_type_broad!="neighbourhood"])

###### Percentage female #######
## Subjective measures
subj_mod_sex <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       mods=percent_female, data = data, subset=exposure_type_broad!="neighbourhood")
subj_mod_sex
# Convert back to r 
fisherz2r(c(subj_mod_sex$beta[2], subj_mod_sex$ci.lb[2], subj_mod_sex$ci.ub[2]))

## Objective measures
obj_mod_sex <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       mods=~percent_female, data = data, subset=exposure_type_broad!="neighbourhood")
obj_mod_sex

# Convert back to r 
fisherz2r(c(obj_mod_sex$beta[2], obj_mod_sex$ci.lb[2], obj_mod_sex$ci.ub[2]))

###### Study quality #######
## Subjective measures
subj_mod_quality <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       mods=Q_total, data = data, subset=exposure_type_broad!="neighbourhood")
subj_mod_quality

# Convert back to r 
fisherz2r(c(subj_mod_quality$beta[2], subj_mod_quality$ci.lb[2], subj_mod_quality$ci.ub[2]))

## Objective measures
obj_mod_quality <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       mods=Q_total, data = data, subset=exposure_type_broad!="neighbourhood")
obj_mod_quality

# Convert back to r 
fisherz2r(c(obj_mod_quality$beta[2], obj_mod_quality$ci.lb[2], obj_mod_quality$ci.ub[2]))
```


```{r}
# Childhood maltreatment: Test for moderation by informant for adversity type, MH outcome, Cross sectional v longitudinal, Study quality, Sex
# Bullying victimisation: Test for moderation by adversity type, MH outcome, Informant, Cross sectional v longitudinal, Study quality, Sex
```

###### 2.7.2 Test for moderation by informant of mental health outcome

```{r}
# Subjective measure of maltreatment
subj_mod_inform <- rma.mv(z_r_subj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                          data = data, mods = ~ Informant_MH_binary, subset=exposure_type_broad =="maltreatment",
                          slab=paste(ref, es_id, sep=", "))
subj_mod_inform

subj_mod_inform <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                   data = data, mods = ~ Informant_MH_binary -1, subset=exposure_type_broad =="maltreatment",
                   slab=paste(ref, es_id, sep=", "))
subj_mod_inform

# Convert back to r 
round(fisherz2r(c(subj_mod_inform$beta[1], subj_mod_inform$ci.lb[1], subj_mod_inform$ci.ub[1])),2) #other
round(fisherz2r(c(subj_mod_inform$beta[2], subj_mod_inform$ci.lb[2], subj_mod_inform$ci.ub[2])),2) #self-report

# Objective measure of maltreatment
# report estimate QM, QM p value
obj_mod_inform <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                  data = data, mods = ~ Informant_MH_binary, subset=exposure_type_broad =="maltreatment",
                  slab=paste(ref, es_id, sep=", "))
obj_mod_inform

obj_mod_inform <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                         data = data, mods = ~ Informant_MH_binary -1, subset=exposure_type_broad =="maltreatment",
                         slab=paste(ref, es_id, sep=", "))
obj_mod_inform

# Convert back to r 
round(fisherz2r(c(obj_mod_inform$beta[1], obj_mod_inform$ci.lb[1], obj_mod_inform$ci.ub[1])),2) #other
round(fisherz2r(c(obj_mod_inform$beta[2], obj_mod_inform$ci.lb[2], obj_mod_inform$ci.ub[2])),2) #self-report

# N studies
data %>% 
  filter(exposure_type_broad=="maltreatment") %>%
  count(ref, Informant_MH_binary) %>%
  group_by(Informant_MH_binary) %>% count(Informant_MH_binary)

# No. ES
table(data$Informant_MH_binary[data$exposure_type_broad=="maltreatment"])

# Subjective measure of bullying
#  report estimate QM, QM p value
subj_mod_inform <- rma.mv(z_r_subj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                          data = data, mods = ~ Informant_MH_binary, subset=exposure_type_broad =="bullying", 
                          slab=paste(ref, es_id, sep=", "))
subj_mod_inform

subj_mod_inform <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                   data = data, mods = ~ Informant_MH_binary -1, subset=exposure_type_broad =="bullying",
                   slab=paste(ref, es_id, sep=", "))
subj_mod_inform

# Convert back to r 
round(fisherz2r(c(subj_mod_inform$beta[1], subj_mod_inform$ci.lb[1], subj_mod_inform$ci.ub[1])),2) #other
round(fisherz2r(c(subj_mod_inform$beta[2], subj_mod_inform$ci.lb[2], subj_mod_inform$ci.ub[2])),2) #self

# Objective measure of bullying
# report estimate QM, QM p value
obj_mod_inform <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                  data = data, mods = ~ Informant_MH_binary, subset=exposure_type_broad =="bullying",
                  slab=paste(ref, es_id, sep=", "))
obj_mod_inform

obj_mod_inform <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                         data = data, mods = ~ Informant_MH_binary -1, subset=exposure_type_broad =="bullying",
                         slab=paste(ref, es_id, sep=", "))
obj_mod_inform

# Convert back to r 
round(fisherz2r(c(obj_mod_inform$beta[1], obj_mod_inform$ci.lb[1], obj_mod_inform$ci.ub[1])),2) #other
round(fisherz2r(c(obj_mod_inform$beta[2], obj_mod_inform$ci.lb[2], obj_mod_inform$ci.ub[2])),2) #self-report

# N studies
data %>% 
  filter(exposure_type_broad=="bullying") %>%
  count(ref, Informant_MH_binary) %>%
  group_by(Informant_MH_binary) %>% count(Informant_MH_binary)

# No. ES
table(data$Informant_MH_binary[data$exposure_type_broad=="bullying"])
```

###### 2.7.3 Test for moderation by study type

###### Cross-sectional vs longitudinal study #######
```{r}
# Intercept is the lowest level (cross sectional coded as 0)
# Mods is longitudinal studies

# Subjective measure of maltreatment
# Obtain the QM and QM p value for subjective maltreatment
subj_mal <-rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                        data = data, mods = ~ StudyDesign, subset = exposure_type_broad =="maltreatment"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
subj_mal

# remove the intercept to get effect sizes in each group
subj_mal <-rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                        data = data, mods = ~ StudyDesign -1, subset = exposure_type_broad =="maltreatment"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
subj_mal

# Convert back to r 
round(fisherz2r(c(subj_mal$beta[1], subj_mal$ci.lb[1], subj_mal$ci.ub[1])),2) # Cross-sectional
round(fisherz2r(c(subj_mal$beta[2], subj_mal$ci.lb[2], subj_mal$ci.ub[2])),2)# Longitudinal

# Objective measure of maltreatment
# Obtain the QM and QM p value 
obj_mal <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                       data = data, mods = ~ StudyDesign, subset = exposure_type_broad =="maltreatment"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
obj_mal
# remove the intercept to get effect sizes in each group
obj_mal <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                        data = data, mods = StudyDesign -1, subset = exposure_type_broad =="maltreatment"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
obj_mal

# Convert back to r 
round(fisherz2r(c(obj_mal$beta[1], obj_mal$ci.lb[1], obj_mal$ci.ub[1])),2) # Cross-sectional
round(fisherz2r(c(obj_mal$beta[2], obj_mal$ci.lb[2], obj_mal$ci.ub[2])),2) # Longitudinal

# N studies
data %>% 
  filter(exposure_type_broad=="maltreatment") %>%
  count(ref, Q_Longitud) %>%
  group_by(Q_Longitud) %>% count(Q_Longitud)

# No. ES
table(data$Q_Longitud[data$exposure_type_broad=="maltreatment"])
```

```{r}
## Subjective measure of bullying
# Obtain the QM and QM p value
subj_bull <-rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                data = data, mods = ~StudyDesign, subset = exposure_type_broad =="bullying"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
subj_bull

# remove the intercept to get effect sizes in each group
subj_bull <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                        data = data, mods = ~ StudyDesign -1, subset = exposure_type_broad =="bullying"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
subj_bull

# Convert back to r 
round(fisherz2r(c(subj_bull$beta[1], subj_bull$ci.lb[1], subj_bull$ci.ub[1])),2) # Cross-sectional
round(fisherz2r(c(subj_bull$beta[2], subj_bull$ci.lb[2], subj_bull$ci.ub[2])),2)# Longitudinal

## Objective measure of bullying
# Obtain the QM and QM p value
obj_bull <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       data = data, mods = ~ StudyDesign, subset = exposure_type_broad =="bullying"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
obj_bull

# remove the intercept to get effect sizes in each group
obj_bull <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
       data = data, mods = ~ StudyDesign-1, subset = exposure_type_broad =="bullying"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
obj_bull

# Convert back to r 
round(fisherz2r(c(obj_bull$beta[1], obj_bull$ci.lb[1], obj_bull$ci.ub[1])),2) # Cross-sectional
round(fisherz2r(c(obj_bull$beta[2], obj_bull$ci.lb[2], obj_bull$ci.ub[2])),2)# Longitudinal

# N studies
data %>% 
  filter(exposure_type_broad=="bullying") %>%
  count(ref, Q_Longitud) %>%
  group_by(Q_Longitud) %>% count(Q_Longitud)

# No. ES
table(data$Q_Longitud[data$exposure_type_broad=="bullying"])
```

###### 2.7.4 Test for moderation by mental health outcome 

```{r}
## Subjective measure of maltreatment
mal_MH_subj<- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                    data = data, mods= ~ MHoutcome_broad, subset = exposure_type_broad =="maltreatment" & !is.na(MHoutcome_broad), slab=paste(ref, es_id, sep=", "))
mal_MH_subj

# Subjective measures,obtain effect size and ci 
mal_MH_subj<- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                     data = data, mods= ~ MHoutcome_broad -1, subset = exposure_type_broad =="maltreatment" & !is.na(MHoutcome_broad), slab=paste(ref, es_id, sep=", "))
mal_MH_subj

# Convert back to r 
round(fisherz2r(c(mal_MH_subj$beta[1], mal_MH_subj$ci.lb[1], mal_MH_subj$ci.ub[1])),2) #externalising
round(fisherz2r(c(mal_MH_subj$beta[2], mal_MH_subj$ci.lb[2], mal_MH_subj$ci.ub[2])),2) #internalising

# Objective measure of maltreatment
mal_MH_obj <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                    data = data, mods= ~ MHoutcome_broad, subset=exposure_type_broad =="maltreatment" & !is.na(MHoutcome_broad), slab=paste(ref, es_id, sep=", "))
mal_MH_obj

mal_MH_obj <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                     data = data, mods= ~ MHoutcome_broad -1, subset=exposure_type_broad =="maltreatment" & !is.na(MHoutcome_broad), slab=paste(ref, es_id, sep=", "))
mal_MH_obj

# Convert back to r 
round(fisherz2r(c(mal_MH_obj$beta[1], mal_MH_obj$ci.lb[1], mal_MH_obj$ci.ub[1])),2) #externalising
round(fisherz2r(c(mal_MH_obj$beta[2], mal_MH_obj$ci.lb[2], mal_MH_obj$ci.ub[2])),2) #internalising

#N Studies
data %>% 
  filter(exposure_type_broad=="maltreatment") %>%
  count(ref, MHoutcome_broad) %>%
  group_by(MHoutcome_broad) %>% count(MHoutcome_broad)

# No. ES
table(data$MHoutcome_broad[data$exposure_type_broad=="maltreatment"])

## Subjective measure of bullying
bull_MH_subj<- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                    data = data, mods= ~ MHoutcome_broad, subset = exposure_type_broad =="bullying" & !is.na(MHoutcome_broad), slab=paste(ref, es_id, sep=", "))
bull_MH_subj

# Subjective measures,obtain effect size and ci 
bull_MH_subj<- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                     data = data, mods= ~ MHoutcome_broad -1, subset = exposure_type_broad =="bullying" & !is.na(MHoutcome_broad), slab=paste(ref, es_id, sep=", "))
bull_MH_subj

# Convert back to r 
round(fisherz2r(c(bull_MH_subj$beta[1], bull_MH_subj$ci.lb[1], bull_MH_subj$ci.ub[1])),2) #externalising
round(fisherz2r(c(bull_MH_subj$beta[2], bull_MH_subj$ci.lb[2], bull_MH_subj$ci.ub[2])),2) #internalising

# Objective measure of bulying
bull_MH_obj <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                    data = data, mods= ~ MHoutcome_broad, subset=exposure_type_broad =="bullying" & !is.na(MHoutcome_broad), slab=paste(ref, es_id, sep=", "))
bull_MH_obj

bull_MH_obj <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                     data = data, mods= ~ MHoutcome_broad -1, subset=exposure_type_broad =="bullying" & !is.na(MHoutcome_broad), slab=paste(ref, es_id, sep=", "))
bull_MH_obj

# Convert back to r 
round(fisherz2r(c(bull_MH_obj$beta[1], bull_MH_obj$ci.lb[1], bull_MH_obj$ci.ub[1])),2) #externalising
round(fisherz2r(c(bull_MH_obj$beta[2], bull_MH_obj$ci.lb[2], bull_MH_obj$ci.ub[2])),2) #internalising

#N Studies
data %>% 
  filter(exposure_type_broad=="bullying") %>%
  count(ref, MHoutcome_broad) %>%
  group_by(MHoutcome_broad) %>% count(MHoutcome_broad)

# No. ES
table(data$MHoutcome_broad[data$exposure_type_broad=="bullying"])
```

##### 2.7.5 Test for moderation by study quality

```{r}
# Intercept is the lowest level of study quality

# Subjective measure of maltreatment
subj_mal_qual <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                        data = data, mods = Q_total, subset = exposure_type_broad =="maltreatment"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
subj_mal_qual

# Convert back to r
fisherz2r(c(subj_mal_qual$beta[2], subj_mal_qual$ci.lb[2], subj_mal_qual$ci.ub[2])) #study quality moderator

# Objective measure of maltreatment
obj_mal_qual <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                      data = data, mods = Q_total, subset = exposure_type_broad =="maltreatment"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
obj_mal_qual

# Convert back to r
fisherz2r(c(obj_mal_qual$beta[2], obj_mal_qual$ci.lb[2], obj_mal_qual$ci.ub[2])) #study quality intercept

# Subjective measure of bullying
subj_bull_qual <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                    data = data, mods = Q_total, subset = exposure_type_broad =="bullying"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
subj_bull_qual

# Convert back to r 
fisherz2r(c(subj_bull_qual$beta[2], subj_bull_qual$ci.lb[2], subj_bull_qual$ci.ub[2])) 

# Objective measure of bullying
obj_bull_qual <-rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                       data = data, mods = Q_total, subset = exposure_type_broad =="bullying"& !is.na(Q_Longitud), slab=paste(ref, es_id, sep=", "))
obj_bull_qual

# Convert back to r 
fisherz2r(c(obj_bull_qual$beta[2], obj_bull_qual$ci.lb[2], obj_bull_qual$ci.ub[2])) 

# Variation between quality of studies
describe(data$Q_total)
```

##### 2.7.6 Test for moderation by sex

```{r}
# Subjective measure of maltreatment
subj_mal_sex <- rma.mv(z_r_subj, z_var_subj,random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                      data = data, mods = percent_female, subset = exposure_type_broad =="maltreatment"& !is.na(percent_female), slab=paste(ref, es_id, sep=", "))
subj_mal_sex
# Convert back to r 
round(fisherz2r(c(subj_mal_sex$beta[2], subj_mal_sex$ci.lb[2], subj_mal_sex$ci.ub[2])),2)

# Objective measure of maltreatment
obj_mal_sex <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                       data = data, mods = percent_female, subset = exposure_type_broad =="maltreatment"& !is.na(percent_female), slab=paste(ref, es_id, sep=", "))
obj_mal_sex

# Convert back to r 
round(fisherz2r(c(obj_mal_sex$beta[2], obj_mal_sex$ci.lb[2], obj_mal_sex$ci.ub[2])),2)

# Subjective measure of bullying
subj_bull_sex <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                       data = data, mods = percent_female, subset = exposure_type_broad =="bullying"& !is.na(percent_female), slab=paste(ref, es_id, sep=", "))
subj_bull_sex

# Convert back to r 
fisherz2r(c(subj_bull_sex$beta[2], subj_bull_sex$ci.lb[2], subj_bull_sex$ci.ub[2])) #sex moderator (female)

# Objective measure of bullying
obj_bull_sex <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                         data = data, mods = percent_female, subset = exposure_type_broad =="bullying"& !is.na(percent_female), slab=paste(ref, es_id, sep=", "))
obj_bull_sex

# Convert back to r 
fisherz2r(c(obj_bull_sex$beta[2], obj_bull_sex$ci.lb[2], obj_bull_sex$ci.ub[2])) #sex mod
```

##### 2.8 Test publication bias

###### 2.8.1 Maltreatment

```{r}
# Egger's Test
res_pub_bias <- rma.mv(z_r_subj, z_var_subj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                       data=data, mods = I(1/N_Included), subset=exposure_type_broad=="maltreatment")
summary (res_pub_bias)

# Egger's Test
res_pub_bias <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                       data=data, mods = I(1/N_Included), subset=exposure_type_broad=="maltreatment") 
summary (res_pub_bias)
```

###### 2.8.2 Bullying

```{r}
# Egger's Test
res_pub_bias <- rma.mv(z_r_subj, z_var_subj,  random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                       data=data, mods = I(1/N_Included), subset=exposure_type_broad=="bullying") 
summary (res_pub_bias)

# Egger's Test
res_pub_bias <- rma.mv(z_r_obj, z_var_obj, random=list(~ 1 | es_id, ~ 1 | ref, ~ 1 | cohort_name),
                       data=data, mods = I(1/N_Included), subset=exposure_type_broad=="bullying") 
summary (res_pub_bias)
```

##### 2.9 Leave one out analysis

###### 2.9.1 Maltreatment

```{r}
groupids <- unique(data$ref[data$exposure_type_broad=="maltreatment"])
groupids <- na.omit(groupids)

leave1out_study <- matrix(rep(NA, length(groupids)), ncol=9, nrow=length(groupids))  

for(i in 1:length(groupids)) {  
  dataexcl <- subset(data, exposure_type_broad=="maltreatment") # subset to maltreatment data
  dataexcl <- subset(dataexcl, ref!=groupids[i])  
  print(nrow(dataexcl))
  
N_rows <- psych::describe(dataexcl$N_Included)$n
mean_N <- psych::describe(dataexcl$N_Included)$mean

# Run meta-analysis for subjective measure
meta_subj <- rma.mv(z_r_subj, z_var_subj,  random=list(~ 1 | es_id, ~ 1 | ref, ~1 | cohort_name), data=dataexcl) 
# Run meta-analysis for objective measure
meta_obj <- rma.mv(z_r_obj, z_var_obj,  random=list(~ 1 | es_id, ~ 1 | ref, ~1 | cohort_name), data=dataexcl) 

# Extract results
  leave1out_study[i,1] <- i # number study omitted
  leave1out_study[i,2] <- N_rows 
  leave1out_study[i,3] <- mean_N 
  leave1out_study[i,4] <- fisherz2r(meta_subj$beta[1]) # subjective ES
  leave1out_study[i,5] <- fisherz2r(meta_subj$ci.lb[1]) # subjective low CI
  leave1out_study[i,6] <- fisherz2r(meta_subj$ci.ub[1]) # subjective upper CI
  leave1out_study[i,7] <- fisherz2r(meta_obj$beta[1]) # objective ES
  leave1out_study[i,8] <- fisherz2r(meta_obj$ci.lb[1]) # objective low CI
  leave1out_study[i,9] <- fisherz2r(meta_obj$ci.ub[1]) # objective upper CI
}

leave1out_study
leave1out_study[,1] <- as.vector(groupids) # Name studies
leave1out_study_df <- as.data.frame(leave1out_study) # Convert to dataframe
names(leave1out_study_df) <-c('ref', 'N_rows', 'Mean_N', 
                              'subj_es', 'subj_ci.lb', 'subj_ci.ub',
                              'obj_es', 'obj_ci.lb', 'obj_ci.ub') # Rename columns
# Convert columns from character to numeric
leave1out_study_df <- leave1out_study_df %>% mutate_at(c('N_rows', 'Mean_N', 
                                                         'subj_es', 'subj_ci.lb', 'subj_ci.ub',
                                                         'obj_es', 'obj_ci.lb', 'obj_ci.ub'), as.numeric)

# Check studies that when removed, led to the minimum and maximum effect size
# Subjective meta-analysis
leave1out_study_df[which.min(leave1out_study_df$subj_es),c('ref', 'subj_es', 'subj_ci.lb', 'subj_ci.ub')]
leave1out_study_df[which.max(leave1out_study_df$subj_es),c('ref', 'subj_es', 'subj_ci.lb', 'subj_ci.ub')]
# Objective meta-analysis
leave1out_study_df[which.min(leave1out_study_df$obj_es),c('ref','obj_es', 'obj_ci.lb', 'obj_ci.ub')]
leave1out_study_df[which.max(leave1out_study_df$obj_es),c('ref','obj_es', 'obj_ci.lb', 'obj_ci.ub')]
```

###### 2.9.2 Bullying

```{r}
groupids <- unique(data$ref[data$exposure_type_broad=="bullying"])
groupids <- na.omit(groupids)

leave_one_out <- function(data, exposure_type) 
  
# Run two lines below separately
groupids <- unique(data$ref[data$exposure_type_broad=="bullying"])
groupids <- na.omit(groupids)
leave1out_study <- matrix(rep(NA, length(groupids)), ncol=9, nrow=length(groupids))  

for(i in 1:length(groupids)) {  
  dataexcl <- subset(data, exposure_type_broad=="bullying") # subset to bullying data
  dataexcl <- subset(dataexcl, ref!=groupids[i])  
  print(nrow(dataexcl))
  
  N_rows <- psych::describe(dataexcl$N_Included)$n
  mean_N <- psych::describe(dataexcl$N_Included)$mean

# Run meta-analysis for subjective measure
meta_subj <- rma.mv(z_r_subj, z_var_subj,  random=list(~ 1 | es_id, ~ 1 | ref, ~1 | cohort_name), data=dataexcl) 
# Run meta-analysis for objective measure
meta_obj <- rma.mv(z_r_obj, z_var_obj,  random=list(~ 1 | es_id, ~ 1 | ref, ~1 | cohort_name), data=dataexcl) 

# Extract results
  leave1out_study[i,1] <- i # number study omitted
  leave1out_study[i,2] <- N_rows 
  leave1out_study[i,3] <- mean_N 
  leave1out_study[i,4] <- fisherz2r(meta_subj$beta[1]) # subjective ES
  leave1out_study[i,5] <- fisherz2r(meta_subj$ci.lb[1]) # subjective low CI
  leave1out_study[i,6] <- fisherz2r(meta_subj$ci.ub[1]) # subjective upper CI
  leave1out_study[i,7] <- fisherz2r(meta_obj$beta[1]) # objective ES
  leave1out_study[i,8] <- fisherz2r(meta_obj$ci.lb[1]) # objective low CI
  leave1out_study[i,9] <- fisherz2r(meta_obj$ci.ub[1]) # objective upper CI
}

leave1out_study
leave1out_study[,1] <- as.vector(groupids) # Name studies
leave1out_study_df <- as.data.frame(leave1out_study) # Convert to dataframe
names(leave1out_study_df) <-c('ref', 'N_rows', 'Mean_N', 
                              'subj_es', 'subj_ci.lb', 'subj_ci.ub',
                              'obj_es', 'obj_ci.lb', 'obj_ci.ub') # Rename columns
# Convert columns from character to numeric
leave1out_study_df <- leave1out_study_df %>% mutate_at(c('N_rows', 'Mean_N', 
                                                         'subj_es', 'subj_ci.lb', 'subj_ci.ub',
                                                         'obj_es', 'obj_ci.lb', 'obj_ci.ub'), as.numeric)

# Check studies that when removed, led to the minimum and maximum effect size
# Subjective meta-analysis
leave1out_study_df[which.min(leave1out_study_df$subj_es),c('ref', 'subj_es', 'subj_ci.lb', 'subj_ci.ub')]
leave1out_study_df[which.max(leave1out_study_df$subj_es),c('ref', 'subj_es', 'subj_ci.lb', 'subj_ci.ub')]
# Objective meta-analysis
leave1out_study_df[which.min(leave1out_study_df$obj_es),c('ref','obj_es', 'obj_ci.lb', 'obj_ci.ub')]
leave1out_study_df[which.max(leave1out_study_df$obj_es),c('ref','obj_es', 'obj_ci.lb', 'obj_ci.ub')]
```
